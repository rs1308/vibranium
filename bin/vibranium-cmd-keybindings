#!/usr/bin/env bash

# Source: Omarchy.
# Adapted for Vibranium

source "$VIBRANIUM_PATH/vibranium-core-lib"

# A script to display Hyprland keybindings defined in your configuration
# using rofi for an interactive search menu.

# Fetch dynamic keybindings from Hyprland
#
# Also do some pre-processing:
# - Remove standard Vibranium bin path prefix
# - Remove uwsm prefix
# - Map numeric modifier key mask to a textual rendition
# - Output comma-separated values that the parser can understand
dynamic_bindings() {
    hyprctl -j binds |
        jq -r '.[] | {modmask, key, keycode, description, dispatcher, arg} | "\(.modmask),\(.key)@\(.keycode),\(.description),\(.dispatcher),\(.arg)"' |
        sed -r \
            -e 's/null//' \
            -e 's,uwsm app -- ,,' \
            -e 's/@0//' \
            -e 's/,@/,code:/' \
            -e 's/^0,/,/' \
            -e 's/^1,/SHIFT,/' \
            -e 's/^4,/CTRL,/' \
            -e 's/^5,/SHIFT CTRL,/' \
            -e 's/^8,/ALT,/' \
            -e 's/^9,/SHIFT ALT,/' \
            -e 's/^12,/CTRL ALT,/' \
            -e 's/^13,/SHIFT CTRL ALT,/' \
            -e 's/^64,/SUPER,/' \
            -e 's/^65,/SUPER SHIFT,/' \
            -e 's/^68,/SUPER CTRL,/' \
            -e 's/^69,/SUPER SHIFT CTRL,/' \
            -e 's/^72,/SUPER ALT,/' \
            -e 's/^73,/SUPER SHIFT ALT,/' \
            -e 's/^76,/SUPER CTRL ALT,/' \
            -e 's/^77,/SUPER SHIFT CTRL ALT,/'
}

# Parse and format keybindings
#
# `awk` does the heavy lifting:
# - Set the field separator to a comma ','.
# - Joins the key combination (e.g., "SUPER + Q").
# - Joins the command that the key executes.
# - Prints everything in a nicely aligned format.
parse_bindings() {
    awk -F, '
{
    # Ignore specific cases
    if ($0 ~ /switch:on:Lid Switch/ || $0 ~ /XF86/) next;

    # Combine the modifier and key (first two fields)
    key_combo = $1 " + " $2;

    # Normalize mouse and scroll naming
    gsub(/mouse_down/, "Scroll down", key_combo);
    gsub(/mouse_up/, "Scroll up", key_combo);
    gsub(/mouse:272/, "Left click", key_combo);
    gsub(/mouse:273/, "Right click", key_combo);

    # Clean up: strip leading "+" if present, trim spaces
    gsub(/^[ \t]*\+?[ \t]*/, "", key_combo);
    gsub(/[ \t]+$/, "", key_combo);

    # Use description, if set
    action = $3;

    if (action == "") {
        # Reconstruct the command from the remaining fields
        for (i = 4; i <= NF; i++) {
            action = action $i (i < NF ? "," : "");
        }

        # Clean up trailing commas, remove leading "exec, ", and trim
        sub(/,$/, "", action);
        gsub(/(^|,)[[:space:]]*exec[[:space:]]*,?/, "", action);
        gsub(/^[ \t]+|[ \t]+$/, "", action);
        gsub(/[ \t]+/, " ", key_combo);  # Collapse multiple spaces to one

        # Escape XML entities
        gsub(/&/, "\\&amp;", action);
        gsub(/</, "\\&lt;", action);
        gsub(/>/, "\\&gt;", action);
        gsub(/"/, "\\&quot;", action);
        gsub(/'"'"'/, "\\&apos;", action);
    }

    if (action != "") {
        printf "%-28s : %s\n", key_combo, action;
    }
}'
}

by_index() {
    local desc="$1"
    hyprctl -j binds |
        jq -r --arg d "$desc" '
	  def modmap(x):
		if x == 0 then ""
		elif x == 1 then "SHIFT"
		elif x == 4 then "CTRL"
		elif x == 5 then "SHIFT CTRL"
		elif x == 8 then "ALT"
		elif x == 9 then "SHIFT ALT"
		elif x == 12 then "CTRL ALT"
		elif x == 13 then "SHIFT CTRL ALT"
		elif x == 64 then "SUPER"
		elif x == 65 then "SUPER SHIFT"
		elif x == 68 then "SUPER CTRL"
		elif x == 69 then "SUPER SHIFT CTRL"
		elif x == 72 then "SUPER ALT"
		elif x == 73 then "SUPER SHIFT ALT"
		elif x == 76 then "SUPER CTRL ALT"
		elif x == 77 then "SUPER SHIFT CTRL ALT"
		else x|tostring end;

	  [.[] | select(.description == $d)] as $matches |
	  if ($matches | length) == 0 then
		"No keybindings found for: " + $d
	  else
		($matches | to_entries[] | "\(.key + 1). " +
		  ((modmap(.value.modmask) + " " + (.value.key // "")) | gsub("^ +| +$";""))
		)
	  end
	'
}

case "$1" in
    "--list" | "-l")
        dynamic_bindings | sort -u | parse_bindings
        ;;
    "--index" | "-i")
        if [[ -z "$2" ]]; then
            echo "--index requires an argument"
            exit 1
        fi
        by_index "$2"
        ;;
    *)
        dynamic_bindings | sort -u | parse_bindings | rofi_cmd \
            "Keybindings" "search shortcuts" -no-auto-select \
            -theme-str 'listview{lines: 30;}'
        ;;
esac
