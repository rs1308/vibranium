#!/usr/bin/env bash

source "$VIBRANIUM_PATH/vibranium-core-lib"

if ! command -v powerprofilesctl > /dev/null; then
    icon="<span foreground='${P_RED}'>\uf071</span>"
    tooltip="<span foreground='${P_ACCENT}'>Power profile:</span> "
    tooltip+="<span foreground='${P_RED}'>command 'powerprofilesctl' not found!</span>"
    printf '{"text": "%s", "tooltip": "%s"}' "$icon" "$tooltip"
    exit 0
fi

check_bool VIBRANIUM_BAR_SHOW_SHORTCUT_HINTS true
check_bool VIBRANIUM_BAR_POWER_PROFILE_MODULE_ENABLE true

if [ "$VIBRANIUM_BAR_POWER_PROFILE_MODULE_ENABLE" = "false" ]; then
    printf '{"text": ""}'
    exit 0
fi

current="$(vibranium-utils-power-profile-get)"
case "$current" in
    "power-saver") icon='\uf06c' ;;
    "balanced") icon=''       ;;
    "performance") icon='\uf0e7' ;;
esac

if [ "$VIBRANIUM_BAR_SHOW_SHORTCUT_HINTS" = "true" ]; then
    bind="$(vibranium-cmd-keybindings -i 'Next power profile' | sed -n '1s/^[0-9]\.\s*//p')"
    profile="<span foreground='${P_ACCENT}'><b> Current profile</b></span>: <span foreground='${P_YELLOW}'><b>${current}</b></span>"
    guide="\n<span foreground='${P_GRAY}'>---------------------------------</span>"
    [ -n "$bind" ] && guide+="\n <span foreground='${P_ACCENT}'><b>${bind}</b></span>: next power profile"
else
    profile="<span foreground='${P_ACCENT}'><b>Current profile:</b></span> <span foreground='${P_YELLOW}'><b>${current}</b></span>"
fi

tooltip="${profile} ${guide}"

printf '{"text": "%s", "tooltip": "%s"}' "$icon" "$tooltip"
