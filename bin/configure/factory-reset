#!/usr/bin/env bash

source "$VIBRANIUM_PATH/vibranium-core-lib"
source "$VIBRANIUM_PATH/configure/configure-lib"

reset_settings() {
    local name="$1"
    local pattern="$2"
    local message="$3"
    local callback="$4"
    local stages=("confirm" "confirm x2" "confirm x3")
    local prompt input

    for stage in "${stages[@]}"; do
        if [ "$name" = "FACTORY RESET" ]; then
            prompt="$name ($stage)"
        else
            prompt="Reset $name settings ($stage)"
        fi
        input="$(printf "%s" "$prompt" | rofi_cmd "Factory reset" "ESC to cancel")"
        [ -z "$input" ] && return 1
        [ "$input" != "$prompt" ] && return 1
    done

    [ -n "$pattern" ] && sed -i "/$pattern/d" "$VIBRANIUM_USER_SETTINGS"

    [ -n "$callback" ] && eval "$callback"

    notify-send -r 1 -t 5000 "Vibranium" "<span foreground='${P_RED}'><b>${message}</b></span>"
}

factory_reset() {
	local looknfeel_opts=(
		"animations:enabled:true"
		"decoration:dim_inactive:true"
		"decoration:rounding:0"
		"decoration:blur:enabled:false"
		"decoration:blur:size:5"
		"decoration:shadow:enabled:true"
	)

	sed -i "/border-radius/s/:.*/:\t0px;/g" "$XDG_CONFIG_HOME/rofi/config.rasi"

	sed -i -e '/corner_radius/s/=.*/= 0/' \
		   -e '/progress_bar_height/s/=.*/= 15/' \
		   -e '/progress_bar_corner_radius/s/=.*/= 0/' \
		   "$XDG_CONFIG_HOME/dunst/dunstrc"

	vibranium-cmd-refresh-dunst
    reset_settings "FACTORY RESET" "VIBRANIUM_" "All settings have been reset to defaults!"

	for opt in "${looknfeel_opts[@]}"; do
		vibranium-cmd-edit-wm-config "$opt" \
			"$XDG_CONFIG_HOME/hypr/hyprland.conf.d/look-and-feel.conf"
	done

	rm "$XDG_CONFIG_HOME/vibranium/theme/current"
	ln -sf "$VIBRANIUM/themes/nightfox-nightfox" \
		"$XDG_CONFIG_HOME/vibranium/theme/current"

	touch "$XDG_CONFIG_HOME/alacritty/alacritty.toml"

	vibranium-core-set-wallpaper \
		$(find .config/vibranium/theme/current/backgrounds -type f,l | sort | head -n1)

	discord_folders=("Vencord" "vesktop")
	for folder in "${discord_folders[@]}"; do
		if [[ -f "$XDG_CONFIG_HOME/${folder}/themes/vibranium.theme.css" ]]; then
			rm -f "$XDG_CONFIG_HOME/${folder}/themes/vibranium.theme.css"
			ln -s "$XDG_CONFIG_HOME/vibranium/theme/current/discord.css" \
				"$XDG_CONFIG_HOME/${folder}/themes/vibranium.theme.css"
		fi
	done

	hyprctl -q reload config-only

	rm "$VIBRANIUM_STATE"/{wallpaper,power-profile,blur.restore}

	if [ ! "$(vibranium-utils-power-profile-get)" = "balanced" ]; then
		vibranium-core-power-profile-set balanced
	fi

	printf "suspended" > "$VIBRANIUM_STATE/night-light"
	vibranium-cmd-refresh-waybar-module worker

	if ! grep -E '^\s*//.*"hyprland/language"' "$XDG_CONFIG_HOME/waybar/config.jsonc"; then
		sed -i 's|^\(\s*\)\("\s*hyprland/language".*\)|\1// \2|' \
			"$XDG_CONFIG_HOME/waybar/config.jsonc"
	fi

	vibranium-cmd-set-waybar-position -q top; systemctl --user restart waybar
	vibranium-theme-update-svgs

}

while true; do
    OPTIONS=(
        "Reset audio settings"
        "Reset global settings"
        "Reset Waybar settings"
        "Reset brightness settings"
        "Reset screenshot settings"
		"Reset appearance settings"
		"Reset color picker settings"
        "Reset screen recording settings"
		"<b><i><u>FACTORY RESET</u></i></b>"
    )
    CHOSEN="$(printf "%s\n" "${OPTIONS[@]}" | rofi_cmd "Factory reset" "ESC to go back")"
    [ -z "$CHOSEN" ] && break

    case "$CHOSEN" in
		"Reset appearance"*)
			reset_settings "appearance" "" "Appearance settings have been restored to defaults!" \
			"
				truncate -s 0 "$XDG_CONFIG_HOME/hypr/hyprland.conf.d/look-and-feel.conf"
				sed -i '/border-radius/s/:.*/: 0px;/g' "$XDG_CONFIG_HOME/rofi/config.rasi"
				sed -i '/corner_radius/s/=.*/= 0/' "$XDG_CONFIG_HOME/dunst/dunstrc"
				vibranium-cmd-refresh-dunst
				hyprctl -q reload config-only
			"
			;;
        "Reset audio"*)
            reset_settings "audio" "VIBRANIUM_VOLUME" "Audio settings have been restored to defaults!"
        ;;
        "Reset global"*)
            reset_settings "global" "VIBRANIUM_GLOBAL" "Global settings have been restored to defaults!"
        ;;
        "Reset Waybar"*)
			vibranium-cmd-set-waybar-position -q top; systemctl --user restart waybar
            reset_settings "Waybar" "VIBRANIUM_BAR" "Waybar settings have been restored to defaults!"
        ;;
        "Reset brightness"*)
            reset_settings "brightness" "VIBRANIUM_BRIGHTNESS" "Brightness settings have been restored to defaults!"
        ;;
        "Reset screenshot"*)
            reset_settings "screenshot" "VIBRANIUM_SCREENSHOT" "Screenshot settings have been restored to defaults!"
        ;;
		"Reset color picker settings")
            reset_settings "color picker" "VIBRANIUM_COLOR_PICKER" "Color picker settings have been restored to defaults!"
			vibranium-cmd-refresh-waybar-module color-picker
		;;
        "Reset screen recording"*)
            reset_settings "screen recording" "VIBRANIUM_RECORDING" "Screen recording settings have been restored to defaults!"
        ;;
		*"FACTORY RESET"*)
			factory_reset
			vibranium-cmd-kill-rofi
			exit 0
    esac
done
