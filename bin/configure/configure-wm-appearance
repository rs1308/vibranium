#!/bin/bash

source "$VIBRANIUM_PATH/vibranium-core-lib"
source "$VIBRANIUM_PATH/configure/configure-lib"

INDEX=0
SMART_GAPS_CONFIG="$XDG_CONFIG_HOME/hypr/hyprland.conf.d/smart-gaps.conf"
HYPR_CONFIG="$XDG_CONFIG_HOME/hypr/hyprland.conf.d/look-and-feel.conf"

edit_int() {
	local name="$1" # prompt
	local key="$2" # hyprland config key
	local input prompt

	while :; do
		prompt="$name (int)"
		input="$(printf "%s" "$prompt" | rofi_cmd "$name" "ESC to go back")"

		[[ -z $input ]] && break
		[[ "$input" == "$prompt" ]] && continue

		if [[ ! "$input" =~ ^[0-9]+$ ]]; then
			notify-send -r 4 -u critical -t 2000 "Vibranium" "Only integers allowed"
			continue
		fi

		vibranium-cmd-edit-wm-config "$key:$input" "$HYPR_CONFIG"
		break
	done
}

while :; do
	mapfile -t lines < <(
		hyprctl --batch -j \
			"getoption decoration:rounding;         \
             getoption animations:enabled;          \
			 getoption general:gaps_in;             \
			 getoption general:gaps_out;            \
			 getoption general:border_size;         \
			 getoption decoration:blur:enabled;     \
			 getoption decoration:dim_inactive;     \
			 getoption decoration:shadow:enabled;   \
			 getoption decoration:active_opacity;   \
			 getoption decoration:inactive_opacity" \
		| jq -r '
		  .option as $o |
		  if   ($o | test("rounding|border_size")) then
			.int
          elif ($o | test(".*_opacity")) then
			  (.float * 10 | round / 10)
		  elif ($o | test("gaps_in|gaps_out")) then
			(.custom | split(" ")[0])
		  else
			if .int == 1 then "true" else "false" end
		  end
		'
	)

		current_smart_gaps=$([ -f "$SMART_GAPS_CONFIG" ] && echo true || echo false)
		current_roundness="${lines[0]}"
		current_animations="${lines[1]}"
		current_gaps_in="${lines[2]}"
		current_gaps_out="${lines[3]}"
		current_border_size="${lines[4]}"
		current_blur="${lines[5]}"
		current_dim="${lines[6]}"
		current_shadow="${lines[7]}"
		current_active_opacity="${lines[8]}"
		current_inactive_opacity="${lines[9]}"

	OPTIONS=(
		"Inactive window opacity : ${current_inactive_opacity}"
		"Active window opacity   : ${current_active_opacity}"
		"Dim inactive window     : ${current_dim}"
		"Drop window shadow      : ${current_shadow}"
		"Animations enabled      : ${current_animations}"
		"Border roundness        : ${current_roundness}px"
	)

	respect="$VIBRANIUM_GLOBAL_RESPECT_POWER_PROFILE"
	if [[ "$respect" = true && "$(vibranium-utils-power-profile-get)" == "power-saver" ]]; then
		OPTIONS+=("<span alpha='50%'>Blur enabled            : ${current_blur}</span> <span foreground='${P_RED}'>()</span>")
	else
		OPTIONS+=("Blur enabled            : ${current_blur}")
	fi

	OPTIONS+=(
		"Border size             : ${current_border_size}"
		"Smart gaps              : ${current_smart_gaps}"
		"Outer gaps              : ${current_gaps_out}"
		"Inner gaps              : ${current_gaps_in}"
	)

	CHOSEN="$(printf "%s\n" "${OPTIONS[@]}" | rofi_cmd "Appearance" "ESC to go back" -selected-row "$INDEX")"
	[[ -z $CHOSEN ]] && break

	for i in "${!OPTIONS[@]}"; do
        if [ "${OPTIONS[$i]}" = "$CHOSEN" ]; then
            INDEX="$i"
            break
        fi
    done

	case "$CHOSEN" in
		"<"*)
			msg="This option is <span foreground='${P_RED}'><b>locked</b></span> "
			msg+="because the current <span foreground='${P_ACCENT}'><b>power profile</b></span> "
			msg+="is <span foreground='${P_GREEN}'><b>powersave</b></span>\n\n"
			msg+="<b>If you want to ignore this, go to the \n"
			msg+="<span foreground='${P_YELLOW}'>Vibranium Menu</span> "
			msg+="<span foreground='${P_ACCENT}'>→</span> "
			msg+="<span foreground='${P_YELLOW}'>Configure Vibranium</span> "
			msg+="<span foreground='${P_ACCENT}'>→</span> "
			msg+="<span foreground='${P_YELLOW}'>General</span> "
			msg+="<span foreground='${P_ACCENT}'>→</span> "
			msg+="<span foreground='${P_YELLOW}'>Respect power profile</span></b>"
			notify-send -r 1 -t 10000 "This option is locked" "$msg"
			;;
		"Inactive window opacity"*)
			while :; do
				prompt="Inactive window opacity (int / float)"
				input="$(printf "%s" "$prompt" | rofi_cmd "Inactive opacity" "0.5 - 1")"
				[[ -z $input ]] && break; [[ "$prompt" == "$input" ]] && continue

				if [[ ! "$input" =~ ^[0-9]+(\.[0-9]+)?$ ]]; then
					notify-send -r 1 -t 2000 "Vibranium" "Only integers or floats allowed"
					continue
				fi

				if [[ ! "$input" =~ ^0(\.[5-9]+)?$|^1(\.0+)?$ ]]; then
					notify-send -r 1 -t 2000 "Vibranium" "Value must be between 0.5 and 1"
					continue
				fi

				vibranium-cmd-edit-wm-config "decoration:inactive_opacity:$input" \
					"$XDG_CONFIG_HOME/hypr/hyprland.conf.d/look-and-feel.conf"
				break
			done
			;;
		"Active window opacity"*)
			while :; do
				prompt="Active window opacity (int / float)"
				input="$(printf "%s" "$prompt" | rofi_cmd "Active opacity" "0.5 - 1")"
				[[ -z $input ]] && break; [[ "$prompt" == "$input" ]] && continue

				if [[ ! "$input" =~ ^[0-9]+(\.[0-9]+)?$ ]]; then
					notify-send -r 1 -t 2000 "Vibranium" "Only integers or floats allowed"
					continue
				fi

				if [[ ! "$input" =~ ^0(\.[5-9]+)?$|^1(\.0+)?$ ]]; then
					notify-send -r 1 -t 2000 "Vibranium" "Value must be between 0.5 and 1"
					continue
				fi

				vibranium-cmd-edit-wm-config "decoration:active_opacity:$input" \
					"$XDG_CONFIG_HOME/hypr/hyprland.conf.d/look-and-feel.conf"
				break
			done
			;;
		"Smart gaps"*)
			while true; do
				sg_opts=("Smart gaps : ${current_smart_gaps}" "What is this?")
				sg_chosen="$(printf "%s\n" "${sg_opts[@]}" | rofi_cmd "Smart gaps" "ESC to go back")"
				[[ -z "$sg_chosen" ]] && break

				case "$sg_chosen" in
					"Smart gaps"*)
						vibranium-cmd-toggle-smart-gaps
						break
						;;
					"What is this?")
						msg="When <span foreground='${P_ACCENT}'><b>only one</b></span> "
						msg+="tiling window is open on the active workspace, all\n"
						msg+="<span foreground='${P_YELLOW}'><b>gaps</b></span>, "
						msg+="<span foreground='${P_YELLOW}'><b>borders</b></span>, "
						msg+="and <span foreground='${P_YELLOW}'><b>shadows</b></span> "
						msg+="are <span foreground='${P_RED}'><b>removed</b></span> "
						msg+="to <span foreground='${P_GREEN}'><b>maximize</b></span> usable screen space"
						notify-send -r 3 -t 10000 "$sg_chosen" "$msg"
						;;
				esac
			done
			;;
		"Inner gaps"*)
			edit_int "Inner gaps" "general:gaps_in"
			;;
		"Outer gaps"*)
			edit_int "Outer gaps" "general:gaps_out"
			;;
		"Border size"*)
			edit_int "Border size" "general:border_size"
			;;
		"Drop window"*)
			case "$current_shadow" in
				true)  vibranium-cmd-edit-wm-config decoration:shadow:enabled:false "$HYPR_CONFIG" ;;
				false) vibranium-cmd-edit-wm-config decoration:shadow:enabled:true  "$HYPR_CONFIG" ;;
			esac
			hyprctl -q reload config-only
			;;
		"Dim inactive"*)
			case "$current_dim" in
				true)  vibranium-cmd-edit-wm-config decoration:dim_inactive:false "$HYPR_CONFIG" ;;
				false) vibranium-cmd-edit-wm-config decoration:dim_inactive:true  "$HYPR_CONFIG" ;;
			esac
			hyprctl -q reload config-only
			;;
		"Border roundness"*)
			while :; do
				prompt="Border rounding (int)"
				input="$(printf "%s\n" "$prompt" | rofi_cmd "Border rounding" "0-16px")"

				[ -z "$input" ] && break;

				[[ ! "$input" =~ ^[0-9]+$ || "$input" == "$prompt" ]] && continue

				if (( input < 0 || input > 16 )); then
					notify-send -r 3 -t 1500 "Vibranium" "<span foreground='${P_RED}'>An integer between 0 and 16!</span>"
					continue
				fi

				vibranium-cmd-edit-wm-config decoration:rounding:"$input" "$HYPR_CONFIG"
				sed -i "/border-radius/s/:.*/:\t${input}px;/" \
					"$XDG_CONFIG_HOME/rofi/config.rasi" \
					"$XDG_CONFIG_HOME/swayosd/style.css"
				sed -i "/corner_radius/s/=.*/= ${input}/" "$XDG_CONFIG_HOME/dunst/dunstrc"
				hyprctl -q reload config-only
				systemctl --user restart swayosd
				vibranium-cmd-refresh-dunst
				break
			done
			;;
		"Animations"*)
			vibranium-cmd-toggle-animations
			;;
		*"()")
			msg="This option is <span foreground='${P_RED}'><b>locked</b></span> "
			msg+="because the global\noption '<span foreground='${P_YELLOW}'><b>Respect Power Profile</b></span>' "
			msg+="is '<span foreground='${P_GREEN}'><b>true</b></span>'\n"
			msg+="and current power profile is '<span foreground='${P_YELLOW}'><b>Powersave</b></span>'"
			notify-send -r 1 -t 5000 "This option is locked" "$msg"
			continue
			;;
		"Blur enabled"*)
			while :; do
				mapfile -t blur_opts < <(
					hyprctl --batch -j \
						"getoption decoration:blur:passes; \
						 getoption decoration:blur:size; \
						 getoption decoration:blur:enabled; \
						 getoption decoration:blur:contrast; \
						 getoption decoration:blur:brightness; \
						 getoption decoration:blur:vibrancy" \
					| jq -r '
					  .option as $o |
					  if ($o | test("passes|size")) then
						.int
					  elif ($o | test("contrast|brightness|vibrancy")) then
						.float
					  else
						if .int == 1 then "true" else "false" end
					  end
					'
				)

				blur_strength="${blur_opts[0]}"
				blur_radius="${blur_opts[1]}"
				blur_enabled="${blur_opts[2]}"
				blur_contrast="${blur_opts[3]}"
				blur_brightness="${blur_opts[4]}"
				blur_saturation="${blur_opts[5]}"

				blur_options=("<b>Enabled    : $blur_enabled</b>")

				if [[ $blur_enabled == false ]]; then
					blur_options+=(
						"<i>Radius</i>     : $blur_radius <span foreground='${P_RED}'>()</span>"
						"<i>Strength</i>   : $blur_strength <span foreground='${P_RED}'>()</span>"
						"<i>Contrast</i>   : $blur_contrast <span foreground='${P_RED}'>()</span>"
						"<i>Brightness</i> : $blur_brightness <span foreground='${P_RED}'>()</span>"
						"<i>Saturation</i> : $blur_saturation <span foreground='${P_RED}'>()</span>"
					)
				else
					blur_options+=(
						"Radius     : $blur_radius"
						"Strength   : $blur_strength"
						"Contrast   : $blur_contrast"
						"Brightness : $blur_brightness"
						"Saturation : $blur_saturation"
					)
				fi

				blur_chosen="$(printf "%s\n" "${blur_options[@]}" | rofi_cmd "Blur" "ESC to go back")"
				[[ -z $blur_chosen ]] && break

				case "$blur_chosen" in
					*"()"*)
						notify-send -r 1 "Vibranium" \
							"<b>This option is <span foreground='${P_RED}'>locked</span> because blur is disabled</b>"
						continue
						;;
					*"Enabled"*)
						if [[ $current_blur == true ]]; then
							rm "$VIBRANIUM_STATE/blur.restore"
						else
							touch "$VIBRANIUM_STATE/blur.restore"
						fi
						vibranium-cmd-toggle-blur
						;;
					"Saturation"*)
						while :; do
							prompt="Blur saturation (float)"
							input="$(printf "%s" "$prompt" | rofi_cmd "Blur saturation"  "0.0 - 1.0")"
							[[ -z $input ]] && break; [[ "$prompt" == "$input" ]] && continue

							if awk -v x="$input" 'BEGIN{exit !(x ~ /^[0-9]*\.?[0-9]+$/ && x>=0 && x<=1)}'; then
								vibranium-cmd-edit-wm-config "decoration:blur:vibrancy:$input" "$HYPR_CONFIG"
								break
							else
								notify-send -r 2 -u critical -t 1500 "Vibranium" \
									"<span foreground='${P_RED}'>A floating point between 0.0 and 1.0!</span>"
								continue
							fi
						done
					;;
					"Brightness"*)
						while :; do
							prompt="Blur brightness (float)"
							input="$(printf "%s" "$prompt" | rofi_cmd "Blur brightness"  "0.0 - 2.0")"
							[[ -z $input ]] && break; [[ "$prompt" == "$input" ]] && continue

							if awk -v x="$input" 'BEGIN{exit !(x ~ /^[0-9]*\.?[0-9]+$/ && x>=0 && x<=2)}'; then
								vibranium-cmd-edit-wm-config "decoration:blur:brightness:$input" "$HYPR_CONFIG"
								break
							else
								notify-send -r 2 -u critical -t 1500 "Vibranium" \
									"<span foreground='${P_RED}'>A floating point between 0.0 and 2.0!</span>"
								continue
							fi
						done
					;;
					"Contrast"*)
						while :; do
							prompt="Blur contrast (float)"
							input="$(printf "%s"  "$prompt" | rofi_cmd "Blur contrast"  "0.0 - 2.0")"
							[[ -z $input ]] && break; [[ "$prompt" == "$input" ]] && continue

							if awk -v x="$input" 'BEGIN{exit !(x ~ /^[0-9]*\.?[0-9]+$/ && x>=0 && x<=2)}'; then
								vibranium-cmd-edit-wm-config "decoration:blur:contrast:$input" "$HYPR_CONFIG"
								break
							else
								notify-send -r 2 -u critical -t 1500 "Vibranium" \
									"<span foreground='${P_RED}'>A floating point between 0.0 and 2.0!</span>"
								continue
							fi
						done
						;;
					"Radius"*)
						while :; do
							prompt="Blur radius (int)"
							input="$(printf "%s" "$prompt" | rofi_cmd "Blur radius"  "ESC to go back")"
							[[ -z $input ]] && break; [[ "$prompt" == "$input" ]] && continue

							if [[ ! $input =~ ^[0-9]+$ ]]; then
								continue
							else
								vibranium-cmd-edit-wm-config "decoration:blur:size:$input" "$HYPR_CONFIG"

								if (( input > 10 )); then
									notify-send -r 1 "Vibranium" "Please note that large values may affect overall performance"
								fi
								break
							fi
						done
						;;
					"Strength"*)
						while :; do
							prompt="Blur strength (int)"
							input="$(printf "%s" "$prompt" | rofi_cmd "Blur strength"  "ESC to go back")"
							[[ -z $input ]] && break; [[ "$prompt" == "$input" ]] && continue

							if [[ ! $input =~ ^[0-9]+$ ]]; then
								continue
							else
								vibranium-cmd-edit-wm-config "decoration:blur:passes:$input" "$HYPR_CONFIG"

								if (( input > 10 )); then
									notify-send -r 1 "Vibranium" "Please note that large values may affect overall performance"
								fi
								break
							fi
						done
				esac
			done
	esac
done

