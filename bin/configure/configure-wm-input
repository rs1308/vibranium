#!/usr/bin/env bash

source "$VIBRANIUM_PATH/vibranium-core-lib"
source "$VIBRANIUM_PATH/configure/configure-lib"

INDEX=0

_touchpad_options() {
	local index=0

	while true; do
		mapfile -t lines < <(
			hyprctl --batch -j \
				"getoption input:touchpad:scroll_factor; \
				 getoption input:touchpad:tap-to-click; \
				 getoption input:touchpad:natural_scroll; \
				 getoption input:touchpad:disable_while_typing" \
			| jq -r ' .option as $o |
			if ($o | test("scroll_factor")) then
				(.float * 10 | round / 10)
			  elif ($o | test("accel_profile")) then
				.str
			  else
				if .int == 1 then "true" else "false" end
			  end
			'
		)

		local current_scroll_factor="${lines[0]}"
		local current_tap_to_click="${lines[1]}"
		local current_natural_scroll="${lines[2]}"
		local current_disable_while_typing="${lines[3]}"
		
		local touchpad_options=(
			"Disable while typing : ${current_disable_while_typing}"
			"Natural scrolling    : ${current_natural_scroll}"
			"Scrolling speed      : ${current_scroll_factor}"
			"Tap to click         : ${current_tap_to_click}"
		)

		local touchpad_chosen="$(printf "%s\n" "${touchpad_options[@]}" | rofi_cmd "Touchpad" "ESC to go back" -selected-row "$index")"
		[[ -z $touchpad_chosen ]] && break

		for i in "${!touchpad_options[@]}"; do
			if [ "${touchpad_options[$i]}" = "$touchpad_chosen" ]; then
				index="$i"
				break
			fi
		done
	
		case "$touchpad_chosen" in
			"Disable while typing"*)
				case "$current_disable_while_typing" in
					true)
						vibranium-cmd-edit-wm-config input:touchpad:disable_while_typing:false \
							"$XDG_CONFIG_HOME/hypr/hyprland.conf.d/input.conf"
						;;
					false)
						vibranium-cmd-edit-wm-config input:touchpad:disable_while_typing:true \
							"$XDG_CONFIG_HOME/hypr/hyprland.conf.d/input.conf"
						;;
				esac
				;;
			"Natural scrolling"*)
				case "$current_natural_scroll" in
					true)
						vibranium-cmd-edit-wm-config input:touchpad:natural_scroll:false \
							"$XDG_CONFIG_HOME/hypr/hyprland.conf.d/input.conf"
						;;
					false)
						vibranium-cmd-edit-wm-config input:touchpad:natural_scroll:true \
							"$XDG_CONFIG_HOME/hypr/hyprland.conf.d/input.conf"
						;;
				esac
				;;
			"Tap to click"*)
				case "$current_tap_to_click" in
					true)
						vibranium-cmd-edit-wm-config input:touchpad:tap-to-click:false \
							"$XDG_CONFIG_HOME/hypr/hyprland.conf.d/input.conf"
						;;
					false)
						vibranium-cmd-edit-wm-config input:touchpad:tap-to-click:true \
							"$XDG_CONFIG_HOME/hypr/hyprland.conf.d/input.conf"
						;;
				esac
				;;
			"Scrolling speed"*)
				while true; do
					prompt="Scrolling speed (int / float)"
					input="$(printf "%s" "$prompt" | rofi_cmd "Scrolling speed" "0.0 - 1.0")"
					[[ -z $input ]] && break
					if [[ "$prompt" == "$input" ]]; then
						continue
					fi

					if [[ ! $input =~ ^(0(\.[0-9]+)?|1(\.0+)?)$ ]]; then
						notify-send -r 1 -t 2000 "Vibranium" "A number between 0 and 1"
						continue
					fi

					vibranium-cmd-edit-wm-config input:touchpad:scroll_factor:$input \
						"$XDG_CONFIG_HOME/hypr/hyprland.conf.d/input.conf"
					break
				done
				;;
		esac
	done
}

while true; do
	mapfile -t lines < <(
		hyprctl --batch -j \
			"getoption input:sensitivity;   \
			 getoption input:accel_profile; \
			 getoption input:repeat_rate;   \
			 getoption input:repeat_delay;  \
			 getoption input:scroll_factor; \
			 getoption input:natural_scroll" \
		| jq -r ' .option as $o |
		if ($o | test("scroll_factor")) then
			(.float * 10 | round / 10)
		  elif ($o | test("sensitivity")) then
			(.float * 100 | round / 100)
		  elif ($o | test("accel_profile")) then
			.str
		elif ($o | test("repeat.*")) then
			.int
		  else
			if .int == 1 then "true" else "false" end
		  end
		'
	)

	devices="$(hyprctl devices)"
	current_sensitivity="${lines[0]}"
	current_accel_profile="$([[ "${lines[1]}" == "adaptive" ]] && echo true || echo false)"
	current_repeat_rate="${lines[2]}"
	current_repeat_delay="${lines[3]}"
	current_scroll_factor="${lines[4]}"
	current_natural_scroll="${lines[5]}"

	OPTIONS=(
		"Keyboard repeat delay : ${current_repeat_delay}ms"
		"Keyboard repeat rate  : ${current_repeat_rate}ms"
		"Mouse acceleration    : ${current_accel_profile}"
		"Natural scrolling     : ${current_natural_scroll}"
		"Mouse sensitivity     : ${current_sensitivity}"
		"Scrolling speed       : ${current_scroll_factor}"
	)

	if [[ "$devices" =~ [Tt]ouchpad ]]; then
		OPTIONS+=("<b>Touchpad options</b>")
	fi

	CHOSEN="$(printf "%s\n" "${OPTIONS[@]}" | rofi_cmd "Input" "ESC to go back" -selected-row "$INDEX")"
	[ -z "$CHOSEN" ] && break

    for i in "${!OPTIONS[@]}"; do
        if [ "${OPTIONS[$i]}" = "$CHOSEN" ]; then
            INDEX="$i"
            break
        fi
    done

	case "$CHOSEN" in
		"Natural scrolling"*)
			case "$current_natural_scroll" in
				true)
					vibranium-cmd-edit-wm-config input:natural_scroll:false \
						"$XDG_CONFIG_HOME/hypr/hyprland.conf.d/input.conf"
					;;
				false)
					vibranium-cmd-edit-wm-config input:natural_scroll:true \
						"$XDG_CONFIG_HOME/hypr/hyprland.conf.d/input.conf"
					
			esac
			;;
		"Scrolling speed"*)
			while true; do
				prompt="Scrolling speed (int / float, (multiplier))"
				input="$(printf "%s" "$prompt" | rofi_cmd "Scrolling speed" "ESC to go back")"
				[[ -z $input ]] && break; [[ "$prompt" == "$input" ]] && continue

				if [[ ! "$input" =~ ^[0-9]+(\.[0-9]+)?$ ]]; then
					notify-send -r 1 -t 2000 "Vibranium" "Only integers or floats allowed"
					continue
				fi

				vibranium-cmd-edit-wm-config "input:scroll_factor:$input" \
					"$XDG_CONFIG_HOME/hypr/hyprland.conf.d/input.conf"
				break
			done
			;;
		"Keyboard repeat delay"*)
			while true; do
				prompt="Repeat delay (int, in ms)"
				input="$(printf "%s" "$prompt" | rofi_cmd "Repeat delay" "200ms - 1000ms")"
				[[ -z $input ]] && break; [[ "$prompt" == "$input" ]] && continue

				if [[ ! "$input" =~ ^[0-9]+$ ]]; then
					notify-send -r 1 -t 2000 "Vibranium" "Only integers allowed"
					continue
				elif (( input < 200 || input > 1000 )); then
					continue
				fi

				vibranium-cmd-edit-wm-config "input:repeat_delay:$input" \
					"$XDG_CONFIG_HOME/hypr/hyprland.conf.d/input.conf"
				break
			done
			;;
		"Keyboard repeat rate"*)
			while true; do
				prompt="Repeat rate (int, in ms)"
				input="$(printf "%s" "$prompt" | rofi_cmd "Repeat rate" "10ms - 50ms")"
				[[ -z $input ]] && break; [[ "$prompt" == "$input" ]] && continue

				if [[ ! "$input" =~ ^[0-9]+$ ]]; then
					notify-send -r 1 -t 2000 "Vibranium" "Only integers allowed"
					continue
				elif (( input < 10 || input > 50 )); then
					continue
				fi

				vibranium-cmd-edit-wm-config "input:repeat_rate:$input" \
					"$XDG_CONFIG_HOME/hypr/hyprland.conf.d/input.conf"
				break
			done
			;;
		"Mouse acceleration"*)
			case "${current_accel_profile}" in
				true)
					vibranium-cmd-edit-wm-config input:accel_profile:flat \
						"$XDG_CONFIG_HOME/hypr/hyprland.conf.d/input.conf"
					;;
				false)
					vibranium-cmd-edit-wm-config input:accel_profile:adaptive \
						"$XDG_CONFIG_HOME/hypr/hyprland.conf.d/input.conf"
					;;
			esac
			;;
		"Mouse sensitivity"*)
			while true; do
				prompt="Sensitivity (int / float)" 
				input="$(printf "%s\n" "$prompt" | rofi_cmd "Sensitivity" "-1 to 1")"
				[[ -z $input ]] && break

				if [[ "$input" == "$prompt" ]]; then
					continue
				fi

				if [[ "$input" =~ ^-?(0(\.[0-9]+)?|1(\.0+)?)$ ]]; then
					vibranium-cmd-edit-wm-config "input:sensitivity:$input" \
						"$XDG_CONFIG_HOME/hypr/hyprland.conf.d/input.conf"
					break
				else
					notify-send -r 1 -t 2000 "Vibranium" "A number between -1 and 1"
				fi
			done
			;;
		*"Touchpad options"*)
			_touchpad_options
			;;
	esac
done
