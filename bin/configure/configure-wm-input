#!/usr/bin/env bash

source "$VIBRANIUM_PATH/vibranium-core-lib"
source "$VIBRANIUM_PATH/configure/configure-lib"

INDEX=0

_touchpad_options() {
	local index=0

	while :; do
		mapfile -t lines < <(
			hyprctl --batch -j \
				"getoption input:touchpad:scroll_factor; \
				 getoption input:touchpad:tap-to-click; \
				 getoption input:touchpad:natural_scroll; \
				 getoption input:touchpad:disable_while_typing" \
			| jq -r ' .option as $o |
			if ($o | test("scroll_factor")) then
				(.float * 10 | round / 10)
			  elif ($o | test("accel_profile")) then
				.str
			  else
				if .int == 1 then "true" else "false" end
			  end
			'
		)

		local current_scroll_factor="${lines[0]}"
		local current_tap_to_click="${lines[1]}"
		local current_natural_scroll="${lines[2]}"
		local current_disable_while_typing="${lines[3]}"

		local touchpad_chosen
		local touchpad_options=(
			"Disable while typing : ${current_disable_while_typing}"
			"Natural scrolling    : ${current_natural_scroll}"
			"Scrolling speed      : ${current_scroll_factor}"
			"Tap to click         : ${current_tap_to_click}"
		)

		touchpad_chosen="$(printf "%s\n" "${touchpad_options[@]}" | rofi_cmd "Touchpad" "ESC to go back" -selected-row "$index")"
		[[ -z $touchpad_chosen ]] && break

		for i in "${!touchpad_options[@]}"; do
			if [ "${touchpad_options[$i]}" = "$touchpad_chosen" ]; then
				index="$i"
				break
			fi
		done

		case "$touchpad_chosen" in
			"Disable while typing"*)
				case "$current_disable_while_typing" in
					true)
						vibranium-cmd-edit-wm-config input:touchpad:disable_while_typing:false \
							"$XDG_CONFIG_HOME/hypr/hyprland.conf.d/input.conf"
						;;
					false)
						vibranium-cmd-edit-wm-config input:touchpad:disable_while_typing:true \
							"$XDG_CONFIG_HOME/hypr/hyprland.conf.d/input.conf"
						;;
				esac
				;;
			"Natural scrolling"*)
				case "$current_natural_scroll" in
					true)
						vibranium-cmd-edit-wm-config input:touchpad:natural_scroll:false \
							"$XDG_CONFIG_HOME/hypr/hyprland.conf.d/input.conf"
						;;
					false)
						vibranium-cmd-edit-wm-config input:touchpad:natural_scroll:true \
							"$XDG_CONFIG_HOME/hypr/hyprland.conf.d/input.conf"
						;;
				esac
				;;
			"Tap to click"*)
				case "$current_tap_to_click" in
					true)
						vibranium-cmd-edit-wm-config input:touchpad:tap-to-click:false \
							"$XDG_CONFIG_HOME/hypr/hyprland.conf.d/input.conf"
						;;
					false)
						vibranium-cmd-edit-wm-config input:touchpad:tap-to-click:true \
							"$XDG_CONFIG_HOME/hypr/hyprland.conf.d/input.conf"
						;;
				esac
				;;
			"Scrolling speed"*)
				while :; do
					prompt="Scrolling speed (int / float)"
					input="$(printf "%s" "$prompt" | rofi_cmd "Scrolling speed" "0.0 - 1.0")"
					[[ -z $input ]] && break
					if [[ "$prompt" == "$input" ]]; then
						continue
					fi

					if [[ ! $input =~ ^(0(\.[0-9]+)?|1(\.0+)?)$ ]]; then
						notify-send -r 1 -t 2000 "Vibranium" "A number between 0 and 1"
						continue
					fi

					vibranium-cmd-edit-wm-config "input:touchpad:scroll_factor:$input" \
						"$XDG_CONFIG_HOME/hypr/hyprland.conf.d/input.conf"
					break
				done
				;;
		esac
	done
}

get_layouts() {
	local path="/usr/share/X11/xkb/symbols"
	local name
	local layouts=()

	for file in "$path"/*; do
		name="${file##*/}"
		if [[ ${#name} -eq 2 && $name =~ ^[a-z][a-z]$ ]]; then
			layouts+=("$name")
		fi
	done

	printf '%s\n' "${layouts[@]}"
}

add_layout() {
    local layouts
    local chosen
    local active_layouts
    local final_layouts

    mapfile -t layouts < <(get_layouts)

    while :; do
        chosen="$(printf "%s\n" "${layouts[@]}" | rofi_cmd "Layouts" "ESC to go back")"

        [[ -z $chosen ]] && break
        if [[ ! " ${layouts[*]} " =~ $chosen ]]; then
            notify-send -r 3 -t 3000 -u critical "Vibranium" "Invalid layout"
            continue
        fi

        active_layouts="$(hyprctl -j getoption input:kb_layout | jq -r '.str')"
        final_layouts="${active_layouts},${chosen}"
        vibranium-cmd-edit-wm-config "input:kb_layout:$final_layouts" \
            "$XDG_CONFIG_HOME/hypr/hyprland.conf.d/input.conf"
        notify-send -r 1 "Vibranium" "Added new Keyboard layout: <b>${chosen^^}</b>"
        break
    done
}

remove_layout() {
    local layouts
    local chosen
    local final_layouts

    while :; do
        IFS=',' read -r -a layouts < <(hyprctl -j getoption input:kb_layout | jq -r '.str')

        chosen="$(printf "%s\n" "${layouts[@]}" | rofi_cmd "Remove layouts" "ESC to go back")"

        [[ -z $chosen ]] && break
        if [[ ! " ${layouts[*]} " =~ $chosen ]]; then
            notify-send -r 3 -t 3000 -u critical "Vibranium" "Invalid layout"
            continue
        fi

        final_layouts=()
        for layout in "${layouts[@]}"; do
            if [[ "$layout" != "$chosen" ]]; then
                final_layouts+=("$layout")
            fi
        done

        final_layouts_str=$(IFS=','; echo "${final_layouts[*]}")

        vibranium-cmd-edit-wm-config "input:kb_layout:$final_layouts_str" \
            "$XDG_CONFIG_HOME/hypr/hyprland.conf.d/input.conf"
        notify-send -r 1 "Vibranium" "Removed existing Keyboard layout: <b>${chosen^^}</b>"
        break
    done
}

layouts_menu() {
    local layouts_opts
    local prompt

    while :; do
        layouts_opts=("Add new" "Remove existing")
        layouts_chosen="$(printf "%s\n" "${layouts_opts[@]}" | rofi_cmd "Keyboard layouts" "ESC to go back")"
        [[ -z $layouts_chosen ]] && break

        case "$layouts_chosen" in
            "Add new")
                add_layout
                ;;
            "Remove existing")
                remove_layout
                ;;
        esac
    done
}


while :; do
	mapfile -t lines < <(
		hyprctl --batch -j \
			"getoption input:sensitivity;    \
			 getoption input:accel_profile;  \
			 getoption input:repeat_rate;    \
			 getoption input:repeat_delay;   \
			 getoption input:scroll_factor;  \
			 getoption input:natural_scroll; \
			 getoption cursor:inactive_timeout; \
			 getoption cursor:hide_on_key_press; \
			 getoption input:kb_layout" \
		| jq -r ' .option as $o |
		if ($o | test("scroll_factor")) then
			(.float * 10 | round / 10)
		  elif ($o | test("sensitivity|inactive_timeout")) then
			(.float * 100 | round / 100)
		  elif ($o | test("accel_profile|kb_layout")) then
			.str
		elif ($o | test("repeat.*")) then
			.int
		else
			if .int == 1 then "true" else "false" end
		  end
		'
	)

	devices="$(hyprctl devices)"
	current_sensitivity="${lines[0]}"
	current_accel_profile="$([[ "${lines[1]}" == "adaptive" ]] && echo true || echo false)"
	current_repeat_rate="${lines[2]}"
	current_repeat_delay="${lines[3]}"
	current_scroll_factor="${lines[4]}"
	current_natural_scroll="${lines[5]}"
	current_cursor_hide="${lines[6]}"
	current_hide_key_press="${lines[7]}"
	current_layouts="${lines[8]}"

	OPTIONS=(
		"Keyboard repeat delay : ${current_repeat_delay}ms"
		"Keyboard repeat rate  : ${current_repeat_rate}"
		"Mouse acceleration    : ${current_accel_profile}"
		"Hide cursor after     : ${current_cursor_hide}s"
		"Hide on key press     : ${current_hide_key_press}"
		"Natural scrolling     : ${current_natural_scroll}"
		"Mouse sensitivity     : ${current_sensitivity}"
		"Keyboard layouts      : ${current_layouts}"
		"Scrolling speed       : ${current_scroll_factor}"
	)

	if [[ "$devices" =~ [Tt]ouchpad ]]; then
		OPTIONS+=("<b>Touchpad options</b>")
	fi

	CHOSEN="$(printf "%s\n" "${OPTIONS[@]}" | rofi_cmd "Input" "ESC to go back" -selected-row "$INDEX")"
	[ -z "$CHOSEN" ] && break

    for i in "${!OPTIONS[@]}"; do
        if [ "${OPTIONS[$i]}" = "$CHOSEN" ]; then
            INDEX="$i"
            break
        fi
    done

	case "$CHOSEN" in
        "Keyboard layouts"*)
            layouts_menu
            ;;
		"Hide on key press"*)
			case "$current_natural_scroll" in
				true)
					vibranium-cmd-edit-wm-config "cursor:hide_on_key_press:false" \
						"$XDG_CONFIG_HOME/hypr/hyprland.conf.d/input.conf"
					;;
				false)
					vibranium-cmd-edit-wm-config "cursor:hide_on_key_press:true" \
						"$XDG_CONFIG_HOME/hypr/hyprland.conf.d/input.conf"

			esac
			;;
		"Hide cursor after"*)
			while :; do
				prompt="Hide cursor after (int, in seconds)"
				input="$(printf "%s" "$prompt" | rofi_cmd "Inactivity timeout" "0 to disable")"
				[[ -z "$input" ]] && break
				[[ "$prompt" == "$input" ]] && continue

				if [[ ! "$input" =~ ^[0-9]+$ ]]; then
					notify-send -r 1 "Vibranium" "Only integers allowed"
					continue
				fi

				vibranium-cmd-edit-wm-config "cursor:inactive_timeout:$input" \
						"$XDG_CONFIG_HOME/hypr/hyprland.conf.d/input.conf"
				break
			done
			;;
		"Natural scrolling"*)
			case "$current_natural_scroll" in
				true)
					vibranium-cmd-edit-wm-config "input:natural_scroll:false" \
						"$XDG_CONFIG_HOME/hypr/hyprland.conf.d/input.conf"
					;;
				false)
					vibranium-cmd-edit-wm-config "input:natural_scroll:true" \
						"$XDG_CONFIG_HOME/hypr/hyprland.conf.d/input.conf"

			esac
			;;
		"Scrolling speed"*)
			while :; do
				prompt="Scrolling speed (int / float, (multiplier))"
				input="$(printf "%s" "$prompt" | rofi_cmd "Scrolling speed" "ESC to go back")"
				[[ -z $input ]] && break; [[ "$prompt" == "$input" ]] && continue

				if [[ ! "$input" =~ ^[0-9]+(\.[0-9]+)?$ ]]; then
					notify-send -r 1 -t 2000 "Vibranium" "Only integers or floats allowed"
					continue
				fi

				vibranium-cmd-edit-wm-config "input:scroll_factor:$input" \
					"$XDG_CONFIG_HOME/hypr/hyprland.conf.d/input.conf"
				break
			done
			;;
		"Keyboard repeat delay"*)
			while :; do
				prompt="Repeat delay (int, in ms)"
				input="$(printf "%s" "$prompt" | rofi_cmd "Repeat delay" "200ms - 1000ms")"
				[[ -z $input ]] && break; [[ "$prompt" == "$input" ]] && continue

				if [[ ! "$input" =~ ^[0-9]+$ ]]; then
					notify-send -r 1 -t 2000 "Vibranium" "Only integers allowed"
					continue
				elif (( input < 200 || input > 1000 )); then
					continue
				fi

				vibranium-cmd-edit-wm-config "input:repeat_delay:$input" \
					"$XDG_CONFIG_HOME/hypr/hyprland.conf.d/input.conf"
				break
			done
			;;
		"Keyboard repeat rate"*)
			while :; do
				prompt="Repeat rate (int, in ms)"
				input="$(printf "%s" "$prompt" | rofi_cmd "Repeat rate" "10ms - 50ms")"
				[[ -z $input ]] && break; [[ "$prompt" == "$input" ]] && continue

				if [[ ! "$input" =~ ^[0-9]+$ ]]; then
					notify-send -r 1 -t 2000 "Vibranium" "Only integers allowed"
					continue
				elif (( input < 10 || input > 50 )); then
					continue
				fi

				vibranium-cmd-edit-wm-config "input:repeat_rate:$input" \
					"$XDG_CONFIG_HOME/hypr/hyprland.conf.d/input.conf"
				break
			done
			;;
		"Mouse acceleration"*)
			case "${current_accel_profile}" in
				true)
					vibranium-cmd-edit-wm-config "input:accel_profile:flat" \
						"$XDG_CONFIG_HOME/hypr/hyprland.conf.d/input.conf"
					;;
				false)
					vibranium-cmd-edit-wm-config "input:accel_profile:adaptive" \
						"$XDG_CONFIG_HOME/hypr/hyprland.conf.d/input.conf"
					;;
			esac
			;;
		"Mouse sensitivity"*)
			while :; do
				prompt="Sensitivity (int / float)"
				input="$(printf "%s\n" "$prompt" | rofi_cmd "Sensitivity" "-1 to 1")"
				[[ -z $input ]] && break

				if [[ "$input" == "$prompt" ]]; then
					continue
				fi

				if [[ "$input" =~ ^-?(0(\.[0-9]+)?|1(\.0+)?)$ ]]; then
					vibranium-cmd-edit-wm-config "input:sensitivity:$input" \
						"$XDG_CONFIG_HOME/hypr/hyprland.conf.d/input.conf"
					break
				else
					notify-send -r 1 -t 2000 "Vibranium" "A number between -1 and 1"
				fi
			done
			;;
		*"Touchpad options"*)
			_touchpad_options
			;;
	esac
done
