#!/usr/bin/env bash

source "$VIBRANIUM_PATH/vibranium-core-lib"
export PATH="$PATH:$VIBRANIUM_PATH/configure"

_hyprland() {
	local hypr_index=0

	while :; do
		hyprland_opts=("Input" "Appearance" "Edit configs" "<b><i>Advanced</i></b>")
		hyprland_chosen="$(printf "%s\n" "${hyprland_opts[@]}" | rofi_cmd "Hyprland" "ESC to go back" -selected-row "$hypr_index")"
		[[ -z $hyprland_chosen ]] && break

		for i in "${!hyprland_opts[@]}"; do
			if [ "${hyprland_opts[$i]}" == "$hyprland_chosen" ]; then
				hypr_index="$i"
				break
			fi
		done

		case "$hyprland_chosen" in
			"Appearance")
				configure-wm-appearance
				;;
			*"Advanced"*)
				configure-wm-advanced
				;;
			"Input")
				configure-wm-input
				;;
			"Edit configs")
				while :; do
					edit_configs_opts=(
						"<b><i>Input devices</i></b>"
						"<b><i>Window rules</i></b>"
						"<b><i>Keybindings</i></b>"
						"<b><i>Monitors</i></b>"
					)
					edit_configs_chosen="$(printf "%s\n" "${edit_configs_opts[@]}" | rofi_cmd "Edit" "ESC to go back")"
					[[ -z $edit_configs_chosen ]] && break

					case "$edit_configs_chosen" in
						*"Input devices"*) vibranium-cmd-launch-terminal "$EDITOR" "$XDG_CONFIG_HOME/hypr/hyprland.conf.d/input.conf"        ;;
						*"Window rules"*)  vibranium-cmd-launch-terminal "$EDITOR" "$XDG_CONFIG_HOME/hypr/hyprland.conf.d/window-rules.conf" ;;
						*"Keybindings"*)   vibranium-cmd-launch-terminal "$EDITOR" "$XDG_CONFIG_HOME/hypr/hyprland.conf.d/binds.conf"        ;;
						*"Monitors"*)      vibranium-cmd-launch-terminal "$EDITOR" "$XDG_CONFIG_HOME/hypr/hyprland.conf.d/monitors.conf"     ;;
					esac
					vibranium-cmd-kill-rofi
				done
			;;
		esac
	done
}

INDEX=0

while :; do
	OPTIONS=(
		"Idle"
		"Audio"
	)

	if [[ "$(systemctl --user is-enabled waybar)" == "enabled" ]]; then
		OPTIONS+=("Waybar")
	else
		OPTIONS+=("<span alpha='70%'>Waybar</span>")
	fi

	OPTIONS+=(
		"General"
		"Set font"
		"Hyprland"
		"Set theme"
		"Recording"
		"Brightness"
		"Screenshots"
		"Night Light"
		"Color Picker"
		"<b><big>FACTORY RESET</big></b>"
	)

	CHOSEN="$(printf "%s\n" "${OPTIONS[@]}" | rofi_cmd "Vibranium" "ESC to go back" -selected-row "$INDEX")"
	[ -z "$CHOSEN" ] && break

    for i in "${!OPTIONS[@]}"; do
        if [ "${OPTIONS[$i]}" == "$CHOSEN" ]; then
            INDEX="$i"
            break
        fi
    done

	case "$CHOSEN" in
		"Waybar")
			waybar-main-menu
			;;
		*"Waybar"*)
			msg="You <span foreground='${P_RED}'><b>disabled</b></span> "
			msg+="Waybar in <span foreground='${P_ACCENT}'><b>Vibranium settings</b></span>! To enable, go to:\n"
			msg+="<span foreground='${P_YELLOW}'><b>Vibranium settings</b></span> <span foreground='${P_BLUE}'><b>→</b></span> "
			msg+="<span foreground='${P_YELLOW}'><b>General</b></span> <span foreground='${P_BLUE}'><b>→</b></span> "
			msg+="<span foreground='${P_YELLOW}'><b>Status bar enabled</b></span> <span foreground='${P_BLUE}'><b>→</b></span> "
			msg+="<span foreground='${P_GREEN}'><b>True</b></span>"
			notify-send -r 3 -t 10000 "Locked" "$msg"
			;;
		"Set font")
			vibranium-font-set
			;;
		"Idle")
			configure-idle
			;;
		"Audio")
			configure-audio
			;;
		"Screenshots")
			configure-screenshots
			;;
		"Brightness")
			configure-brightness
			;;
		"Recording")
			configure-recording
			;;
		"Night Light")
			configure-night-light
			;;
		"Color Picker")
			configure-color-picker
			;;
		"Set theme")
			if vibranium-theme-set; then
				vibranium-cmd-kill-rofi
				exit 0
			fi
			;;
		"General")
			configure-global-options
			;;
		"Hyprland")
			_hyprland
			;;
		*"FACTORY RESET"*)
			msg="Sorry, this needs some polishing and bug fixes, "
			msg+="so it's not available at the moment"
			notify-send -r 1 -t 5000 "Vibranium" "$msg"
			# factory-reset
			;;
	esac
done
