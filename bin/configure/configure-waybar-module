#!/usr/bin/env bash

source "$VIBRANIUM_PATH/vibranium-core-lib"
source "$VIBRANIUM_PATH/configure/configure-lib"

OPTIONS=("Pacman" "Weather" "Color Picker" "Sleep inhibitor")
INDEX=0

while :; do
	CHOSEN="$(printf "%s\n" "${OPTIONS[@]}" | rofi_cmd "Module settings" "ESC to go back" -selected-row "$INDEX")"
	[ -z "$CHOSEN" ] && exit 0

    for i in "${!OPTIONS[@]}"; do
        if [ "${OPTIONS[$i]}" = "$CHOSEN" ]; then
			INDEX="$i"
			break
        fi
    done

	case "$CHOSEN" in
		"Sleep inhibitor")
			inhibitor_index=0
			while :; do
				inhibitor_options=("coffee" "lock" "eye")
				inhibitor_chosen="$(printf "%s\n" "${inhibitor_options[@]}" | rofi_cmd "Icon" "ESC to go back" -selected-row "$inhibitor_index")"
				[[ -z "$inhibitor_chosen" ]] && break

				for i in "${!inhibitor_options[@]}"; do
					if [ "${inhibitor_options[$i]}" = "$inhibitor_chosen" ]; then
						inhibitor_index="$i"
						break
					fi
				done

				case "$inhibitor_chosen" in
					"coffee"|"lock"|"eye")
						option-validate "VIBRANIUM_BAR_INHIBITOR_ICON"
						sed -i "/^VIBRANIUM_BAR_INHIBITOR_ICON/s/=.*/=\"${inhibitor_chosen}\"/" "$VIBRANIUM_USER_SETTINGS"
						vibranium-cmd-refresh-waybar-module inhibitor
						;;
				esac
			done
			;;
		"Pacman")
			while :; do
				new_value="$(printf "Enter new value (int)" | rofi_cmd "Display if â‰¥ N updates" "ESC to go back")"
				[ -z "$new_value" ] && break

				if [[ "$new_value" =~ ^[0-9]+$ ]]; then
					option-validate "VIBRANIUM_BAR_PACMAN_MODULE_MINIMUM_PACKAGES_REQUIRED"
					sed -i "/^VIBRANIUM_BAR_PACMAN_MODULE_MINIMUM_PACKAGES_REQUIRED/s/=.*/=${new_value}/" "$VIBRANIUM_USER_SETTINGS"

					if [[ "$VIBRANIUM_BAR_PACMAN_MODULE_ENABLE" == "true" ]]; then
						vibranium-cmd-refresh-waybar-module pacman
					else
						notify-send -r 1 -t 5000 "Vibranium" "The value was successfully changed, but the module is disabled!"
					fi
					exit 0
				fi
			done
			;;
		"Color Picker")
			cp_index=0
			cp_options=("History size" "Change icon")

			while :; do
				cp_chosen="$(printf "%s\n" "${cp_options[@]}" | rofi_cmd "$CHOSEN" "ESC to go back" -selected-row "$cp_index")"
				[[ -z "$cp_chosen" ]] && break

				for i in "${!cp_options[@]}"; do
					if [ "${cp_options[$i]}" = "$cp_chosen" ]; then
						cp_index="$i"
						break
					fi
				done

				case "$cp_chosen" in
					"Change icon")
						icon_index=0
						while :; do
							icon_options=("droplet" "palette" "eyedropper")
							icon_chosen="$(printf "%s\n" "${icon_options[@]}" | rofi_cmd "Icon" "ESC to go back" -selected-row "$icon_index")"
							[ -z "$icon_chosen" ] && break

							for i in "${!icon_options[@]}"; do
								if [ "${icon_options[$i]}" = "$icon_chosen" ]; then
									icon_index="$i"
									break
								fi
							done

							if [[ "${icon_options[*]}" =~ $icon_chosen ]]; then
								option-validate "VIBRANIUM_COLOR_PICKER_WAYBAR_ICON"
								sed -i "/^VIBRANIUM_COLOR_PICKER_WAYBAR_ICON/s/=.*/=\"${icon_chosen}\"/" \
									"$VIBRANIUM_USER_SETTINGS"
								vibranium-cmd-refresh-waybar-module color-picker
								break
							fi
						done
						;;
					"History size")
						history_file="$XDG_CACHE_HOME/vibranium/color-picker.history"
						while :; do
							hs_opts=("3" "5" "10" "15")
							hs_chosen="$(printf "%s entries\n" "${hs_opts[@]}" | rofi_cmd "$cp_chosen" "ESC to go back")"
							[[ -z "$hs_chosen" ]] && break; hs_chosen="${hs_chosen%% *}"

							if [[ "${hs_opts[*]}" =~ $hs_chosen ]]; then
								option-validate "VIBRANIUM_COLOR_PICKER_HISTORY_SIZE"
								sed -i "/^VIBRANIUM_COLOR_PICKER_HISTORY_SIZE/s/=.*/=\"${hs_chosen}\"/" \
									"$VIBRANIUM_USER_SETTINGS"

								if [[ -f "$history_file" ]]; then
									line_count=$(wc -l < "$history_file")
									if (( line_count > hs_chosen )); then
										tail -n "$hs_chosen" "$history_file" > "${history_file}.tmp" \
											&& mv "${history_file}.tmp" "$history_file"
									fi
								fi

								vibranium-cmd-refresh-waybar-module color-picker
								break
							fi
						done
						;;
				esac
			done
			;;
		"Weather")
			while :; do
				new_value="$(printf "Enter new value (string)" | rofi_cmd "City" "current is ${VIBRANIUM_BAR_WEATHER_MODULE_CITY}")"
				[ -z "$new_value" ] && break; [[ ! "$new_value" =~ ^[A-Za-z]+$ ]] && {
					notify-send -r 1 -u critical -t 2000 "Vibranium" "Invalid city name!"
					continue
				}

				opt_name="VIBRANIUM_BAR_WEATHER_MODULE_CITY"; option-validate "$opt_name"
				sed -i "s|^${opt_name}=.*|${opt_name}=\"${new_value}\"|" "$VIBRANIUM_USER_SETTINGS"
				msg="Monitoring weather in <span foreground='${P_ACCENT}'><b>$new_value</b></span>"

				if [ "$(vibranium-cmd-get-option VIBRANIUM_BAR_WEATHER_MODULE_ENABLE)" = "true" ]; then
					notify-send -r 1 "City updated!" "$msg"
					vibranium-cmd-refresh-waybar-module weather
				else
					notify-send -r 1 "City updated, but you forgot to enable the module" "$msg"
				fi
				break
			done
			;;
	esac
done
