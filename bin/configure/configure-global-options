#!/usr/bin/env bash

source "$VIBRANIUM_PATH/vibranium-core-lib"
source "$VIBRANIUM_PATH/configure/configure-lib"

INDEX=0

_terminal_opacity() {
    local action
    local value
    local cfg

    action="$1"
    value="$2"
    cfg="$XDG_CONFIG_HOME/alacritty/alacritty.toml"

    case "$action" in
        "get")
            sed -nE '/^\[window\]/,/^\[/{s/^[[:space:]]*opacity[[:space:]]*=[[:space:]]*"?([0-9.]+)"?/\1/p}' \
                "$cfg"
            ;;
        "set")
            sed -i -E '/^\[window\]/,/^\[/{s/^([[:space:]]*opacity[[:space:]]*=[[:space:]]*)"?[0-9.]+("?)/\1'"$value"'\2/}' \
                "$cfg"
            ;;
    esac
}

# shhh
_flash_submenu() {
    local enabled_var="$1" speed_var="$2" title="$3"
    local index=0

    while :; do
        source "$VIBRANIUM_USER_SETTINGS"

        local chosen
        local opts=("Enabled : ${!enabled_var}")

        if [[ "${!enabled_var}" == true ]]; then
            opts+=("Speed   : ${!speed_var//_/ }")
        else
            opts+=("<span alpha='70%'>Speed   : ${!speed_var//_/ }</span> <span foreground='${P_RED}'>()</span>")
        fi

        chosen="$(printf "%s\n" "${opts[@]}" | rofi_cmd "$title" "ESC to go back" -selected-row "$index")"
        [[ -z "$chosen" ]] && break

        for i in "${!opts[@]}"; do
            if [[ "${opts[$i]}" == "$chosen" ]]; then
                index="$i"
                break
            fi
        done

        case "$chosen" in
            *""*)
                continue
                ;;
            "Enabled"*)
                toggle_bool "$enabled_var"
                ;;
            "Speed"*)
                s_index=0
                while :; do
                    spd_opts=("Slow" "Medium" "Fast" "Very fast")
                    spd_chosen="$(printf "%s\n" "${spd_opts[@]}" | rofi_cmd "Effect speed" "ESC to go back" -selected-row "$s_index")"
                    [[ -z "$spd_chosen" ]] && break

                    local valid=false
                    for i in "${!spd_opts[@]}"; do
                        if [[ "${spd_opts[$i]}" == "$spd_chosen" ]]; then
                            s_index="$i"
                            valid=true
                            break
                        fi
                    done

                    $valid || continue

                    spd_chosen="${spd_chosen,,}"
                    spd_chosen="${spd_chosen// /_}"

                    option-validate "$speed_var"
                    sed -i "/^${speed_var}/s/=.*/=\"${spd_chosen}\"/" "$VIBRANIUM_USER_SETTINGS"
                    break
                done
                ;;
        esac
    done
}

_lockscreen_blur_menu() {
    local blur_lockscreen_options
    local blur_lockscreen_chosen

    while :; do
        source "$VIBRANIUM_USER_SETTINGS"

        if [[ $VIBRANIUM_GLOBAL_BLUR_LOCKSCREEN_BACKGROUND == false ]]; then
            blur_lockscreen_options=(
                "Blur background : $VIBRANIUM_GLOBAL_BLUR_LOCKSCREEN_BACKGROUND"
                "Dim strength    : $VIBRANIUM_GLOBAL_DIM_LOCKSCREEN_STRENGTH"
            )
        else
            blur_lockscreen_options=(
                "Blur background : $VIBRANIUM_GLOBAL_BLUR_LOCKSCREEN_BACKGROUND"
                "Blur strength   : $VIBRANIUM_GLOBAL_BLUR_LOCKSCREEN_STRENGTH"
            )
        fi

        blur_lockscreen_chosen="$(printf "%s\n" "${blur_lockscreen_options[@]}" | rofi_cmd "Lockscreen background" "ESC to go back")"
        [[ -z $blur_lockscreen_chosen ]] && break

        case "$blur_lockscreen_chosen" in
            "Blur background"*)
                toggle_bool VIBRANIUM_GLOBAL_BLUR_LOCKSCREEN_BACKGROUND
                if [ -f "$XDG_RUNTIME_DIR/vibranium-lockscreen-cache.pid" ]; then
                    local pid
                    pid=$(< "$XDG_RUNTIME_DIR/vibranium-lockscreen-cache.pid")
                    if kill -0 "$pid" 2> /dev/null; then
                        kill -TERM "$pid"
                    fi
                fi
                (setsid vibranium-utils-lockscreen-cache) &
                ;;
            "Blur strength"*)
                local blur_strength_options
                local blur_strength_options

                while :; do
                    blur_strength_options=("low" "mid" "hard")
                    blur_strength_chosen="$(printf "%s\n" "${blur_strength_options[@]}" | rofi_cmd "Blur strength" "ESC to go back")"
                    [[ -z $blur_strength_chosen ]] && break
                    [[ $blur_strength_chosen == "$VIBRANIUM_GLOBAL_BLUR_LOCKSCREEN_STRENGTH" ]] && break

                    if [[ ! ${blur_strength_options[*]} =~ $blur_strength_chosen ]]; then
                        continue
                    else
                        option-validate "VIBRANIUM_GLOBAL_BLUR_LOCKSCREEN_STRENGTH"
                        sed -i "/VIBRANIUM_GLOBAL_BLUR_LOCKSCREEN_STRENGTH/s/=.*/=\"${blur_strength_chosen}\"/" "$VIBRANIUM_USER_SETTINGS"
                        if [ -f "$XDG_RUNTIME_DIR/vibranium-lockscreen-cache.pid" ]; then
                            local pid
                            pid=$(< "$XDG_RUNTIME_DIR/vibranium-lockscreen-cache.pid")
                            if kill -0 "$pid" 2> /dev/null; then
                                kill -TERM "$pid"
                            fi
                        fi
                        (setsid vibranium-utils-lockscreen-cache) &
                        break
                    fi
                done
                ;;
            "Dim strength"*)
                local dim_strength_options
                local dim_strength_chosen

                while :; do
                    dim_strength_options=("low" "mid" "hard")
                    dim_strength_chosen="$(printf "%s\n" "${dim_strength_options[@]}" | rofi_cmd "Dim strength" "ESC to go back")"
                    [[ -z $dim_strength_chosen ]] && break
                    [[ $dim_strength_chosen == "$VIBRANIUM_GLOBAL_DIM_LOCKSCREEN_STRENGTH" ]] && break

                    if [[ ! ${dim_strength_options[*]} =~ $dim_strength_chosen ]]; then
                        continue
                    else
                        option-validate "VIBRANIUM_GLOBAL_DIM_LOCKSCREEN_STRENGTH"
                        sed -i "/VIBRANIUM_GLOBAL_DIM_LOCKSCREEN_STRENGTH/s/=.*/=\"${dim_strength_chosen}\"/" "$VIBRANIUM_USER_SETTINGS"
                        if [ -f "$XDG_RUNTIME_DIR/vibranium-lockscreen-cache.pid" ]; then
                            local pid
                            pid=$(< "$XDG_RUNTIME_DIR/vibranium-lockscreen-cache.pid")
                            if kill -0 "$pid" 2> /dev/null; then
                                kill -TERM "$pid"
                            fi
                        fi
                        (setsid vibranium-utils-lockscreen-cache) &
                        break
                    fi
                done
                ;;
        esac
    done
}

while :; do
    source "$VIBRANIUM_USER_SETTINGS"

    bar_enabled="$([ "$(systemctl --user is-active waybar)" = "active" ] && echo true || echo false)"

    OPTIONS=(
        "Now playing              : $VIBRANIUM_GLOBAL_SHOW_NOW_PLAYING"
        "OSD enabled              : $VIBRANIUM_GLOBAL_USE_OSD"
        "Show wallpaper           : $VIBRANIUM_GLOBAL_SHOW_WALLPAPER"
        "Show status bar          : $bar_enabled"
        "Confirm to kill          : $VIBRANIUM_GLOBAL_CONFIRM_TO_KILL"
        "Blur lockscreen          : $VIBRANIUM_GLOBAL_BLUR_LOCKSCREEN_BACKGROUND"
        "Power menu style         : $VIBRANIUM_GLOBAL_POWER_MENU_STYLE"
        "Copy to clipboard        : $VIBRANIUM_GLOBAL_COPY_TO_CLIPBOARD"
        "Pause music on lock      : $VIBRANIUM_GLOBAL_PAUSE_MUSIC_ON_SESSION_LOCK"
        "Welcome notification     : $VIBRANIUM_GLOBAL_SHOW_WELCOME_BACK_NOTIFICATION"
        "Terminal transparency    : $(_terminal_opacity get)"
        "Video downscale use GPU  : $VIBRANIUM_VIDEO_DOWNSCALE_USE_GPU"
        "<b>App launcher settings</b>"
    )

    if [[ "$(hyprctl -j getoption animations:enabled | jq -r .int)" == 1 ]]; then
        OPTIONS+=("<b>Screen / Border flash</b>")
    else
        OPTIONS+=("<span alpha='70%'><b>Screen / Border flash</b></span> <span foreground='${P_RED}'>()</span>")
    fi

    OPTIONS+=(
        "<b>Player options</b>"
        "<b>Power profiles</b>"
        "<b>Notifications</b>"
        "<b>Edit env vars</b>"
    )

    CHOSEN="$(printf "%s\n" "${OPTIONS[@]}" | rofi_cmd "Global options" "ESC to go back" -selected-row "$INDEX")"
    [ -z "$CHOSEN" ] && break

    for i in "${!OPTIONS[@]}"; do
        if [[ "${OPTIONS[$i]}" == "$CHOSEN" ]]; then
            INDEX="$i"
            break
        fi
    done

    case "$CHOSEN" in
        "Show status bar"*)
            case "$bar_enabled" in
                "true") systemctl --user disable --now waybar ;;
                "false") systemctl --user enable --now waybar ;;
            esac
            ;;
        "Show wallpaper"*)
            case "$(toggle_bool -v "VIBRANIUM_GLOBAL_SHOW_WALLPAPER")" in
                false)
                    systemctl -q --user disable --now hyprpaper
                    # In case we were in powersave mode and the cache generator was waiting for its turn
                    if [ -f "$XDG_RUNTIME_DIR/vibranium-lockscreen-cache.pid" ]; then
                        pid=$(< "$XDG_RUNTIME_DIR/vibranium-lockscreen-cache.pid")
                        if kill -0 "$pid" 2> /dev/null; then
                            kill -TERM "$pid"
                        fi
                    fi
                    ;;
                true)
                    systemctl -q --user enable --now hyprpaper &
                    vibranium-utils-lockscreen-cache &
                    ;;
            esac
            ;;
        *"Player options"*)
            configure-player
            ;;
        "Video downscale"*)
            while :; do
                downscale_options=(
                    "Use GPU when possible : $VIBRANIUM_VIDEO_DOWNSCALE_USE_GPU"
                    "README"
                )
                downscale_chosen="$(printf "%s\n" "${downscale_options[@]}" | rofi_cmd "Video downscale" "ESC to go back")"
                [[ -z "$downscale_chosen" ]] && break

                case "$downscale_chosen" in
                    "Use"*)
                        toggle_bool "VIBRANIUM_VIDEO_DOWNSCALE_USE_GPU"
                        break
                        ;;
                    "README")
                        msg="\n<span foreground='${P_ACCENT}'><b>•</b></span> "
                        msg+="<b>Whether to use GPU encoders when processing a video</b>\n\n"
                        msg+="<span foreground='${P_RED}'>Please ensure that you have installed all necessary GPU drivers</span>\n\n"
                        msg+="Keep in mind that, although using a GPU for video processing may be faster and more power efficient, "
                        msg+="the result is usually slightly worse than with CPU\n\nIf your goal is to significantly reduce file size "
                        msg+="while losing as little detail as possible, a CPU is better suited for the task"
                        notify-send -r 3 -t 20000 "Vibranium" "$msg"
                        ;;
                esac
            done
            ;;
        *"Edit env vars"*)
            vibranium-cmd-launch-terminal "$EDITOR" "$XDG_CONFIG_HOME/vibranium/environment"
            vibranium-cmd-kill-rofi
            exit 0
            ;;
        "Terminal"*)
            while :; do
                prompt="Terminal transparency (float)"
                input="$(printf "%s" "$prompt" | rofi_cmd "Terminal transparency" "0.0 - 1.0")"
                [[ -z "$input" ]] && break
                [[ "$prompt" == "$input" ]] && continue

                if [[ "$input" =~ ^0(\.[0-9]+)?$ || "$input" == "1" || "$input" == "1.0" ]]; then
                    [[ "$input" == 1 ]] && input="1.0"
                    _terminal_opacity set "$input"
                    break
                else
                    notify-send -r 2 -u critical -t 1500 "Vibranium" \
                        "A floating point between 0.0 and 1.0!"
                fi
            done
            ;;
        *"Power profiles"*)
            pp_index=0
            while true; do
                source "$VIBRANIUM_USER_SETTINGS"
                use_feedback="$VIBRANIUM_GLOBAL_POWER_PROFILE_USE_FEEDBACK"
                use_pp_osd="$VIBRANIUM_GLOBAL_POWER_PROFILE_USE_OSD"
                use_osd="$VIBRANIUM_GLOBAL_USE_OSD"

                pp_opts=("Respect power profile : $VIBRANIUM_GLOBAL_RESPECT_POWER_PROFILE")
                pp_opts+=("Use visual feedback   : $use_feedback")

                if [[ "$use_feedback" == true && "$use_osd" == true ]]; then
                    pp_opts+=("Use OSD               : $use_pp_osd")
                else
                    pp_opts+=("<span alpha='70%'>Use OSD               : $use_pp_osd</span> <span foreground='${P_RED}'>()</span>")
                fi

                pp_chosen="$(printf "%s\n" "${pp_opts[@]}" | rofi_cmd "Power profiles" "ESC to go back" -selected-row "$pp_index")"
                [[ -z "$pp_chosen" ]] && break

                for i in "${!pp_opts[@]}"; do
                    if [ "${pp_opts[$i]}" = "$pp_chosen" ]; then
                        pp_index="$i"
                        break
                    fi
                done

                case "$pp_chosen" in
                    "Use visual"*) toggle_bool VIBRANIUM_GLOBAL_POWER_PROFILE_USE_FEEDBACK ;;
                    "Use OSD"*)    toggle_bool VIBRANIUM_GLOBAL_POWER_PROFILE_USE_OSD      ;;
                    *"()"*)
                        if [[ "$use_feedback" == false ]]; then
                            msg="Visual feedback is disabled. Enable it first"
                            pp_index=1
                        else
                            msg="OSD is disabled globally. To enable OSD, go to: \n"
                            msg+="<span foreground='${P_YELLOW}'>Vibranium settings</span> <span foreground='${P_BLUE}'>→</span> "
                            msg+="<span foreground='${P_YELLOW}'>Configure Vibranium</span> <span foreground='${P_BLUE}'>→</span> "
                            msg+="<span foreground='${P_YELLOW}'>General</span>"
                        fi
                        notify-send -r 1 "This option is locked" "$msg"
                        ;;
                    "Respect"*)
                        while :; do
                            respect_power_profile_options=(
                                "Respect power profile : $VIBRANIUM_GLOBAL_RESPECT_POWER_PROFILE"
                                "What is this?"
                            )
                            respect_power_profile_chosen="$(printf "%s\n" "${respect_power_profile_options[@]}" | rofi_cmd "Respect power profile" "ESC to go back")"
                            [ -z "$respect_power_profile_chosen" ] && break

                            case "$respect_power_profile_chosen" in
                                "Respect"*)
                                    # Ok, so imagine this: user sets VIBRANIUM_GLOBAL_RESPECT_POWER_PROFILE to false, then
                                    # uses blur for a while in, let’s say, power-saver mode. When the user decides to turn
                                    # VIBRANIUM_GLOBAL_RESPECT_POWER_PROFILE back on, blur will disappear (if in power-saver,
                                    # as expected). That’s fine, that’s how it should work. But when the user switches to a
                                    # non–power-saver profile, blur won’t restore on its own. The logic below uses a state
                                    # file to handle that.
                                    conf="$XDG_CONFIG_HOME/hypr/hyprland.conf.d/look-and-feel.conf"

                                    # $ time hyprctl -j getoption decoration:blur:enabled | jq '.set'
                                    #
                                    # real  0m0.004s
                                    # user  0m0.003s
                                    # sys   0m0.002s
                                    #
                                    # $ time <sed command below>
                                    #
                                    # real  0m0.001s
                                    # user  0m0.001s
                                    # sys   0m0.000s
                                    #
                                    # Call me crazy, I don’t care
                                    blur_enabled="$(sed -n '/decoration[[:space:]]*{/,/}/{/blur[[:space:]]*{/,/}/{s/.*enabled[[:space:]]*=[[:space:]]*\([^;]*\).*/\1/p}}' "$conf" 2> /dev/null)"

                                    # One-time execution at this point
                                    [ -z "$blur_enabled" ] && {
                                        blur_enabled="$(vibranium-cmd-edit-wm-config decoration:blur:enabled:"$(hyprctl -j getoption decoration:blur:enabled | jq '.set')" "$conf")"
                                    }

                                    if [ "$(toggle_bool -v "VIBRANIUM_GLOBAL_RESPECT_POWER_PROFILE")" = "true" ]; then
                                        # If on power-saver and blur is on → disable blur and save blur status for later restore
                                        if [[ "$(vibranium-utils-power-profile-get)" == "power-saver" && "$blur_enabled" == true ]]; then
                                            touch "$VIBRANIUM_STATE/blur.restore"
                                            vibranium-cmd-toggle-blur
                                        fi
                                    else
                                        # Coming from VIBRANIUM_GLOBAL_RESPECT_POWER_PROFILE = true → false
                                        # Restore blur
                                        if [[ -f "$VIBRANIUM_STATE/blur.restore" ]] && [[ $blur_enabled = false ]]; then
                                            rm "$VIBRANIUM_STATE/blur.restore"
                                            vibranium-cmd-toggle-blur
                                        fi
                                    fi
                                    break
                                    ;;
                                "What"*)
                                    msg="\n<span foreground='${P_ACCENT}'><b>•</b></span> <b>Whether to respect the active power profile when processing compute tasks</b>\n\n"
                                    msg+="When enabled, power and GPU hungry processes like cache generation, blur,\ncompute tasks, etc will be suspended on "
                                    msg+="'<span foreground='${P_GREEN}'>power-saver</span>' power profile"
                                    notify-send -r 3 -t 15000 "What is this?" "$msg"
                                    ;;
                            esac
                        done
                        ;;
                esac
            done
            ;;
        "Copy to clipboard"*)
            while :; do
                copy_to_clipboard_options=("Copy to clipboard : $VIBRANIUM_GLOBAL_COPY_TO_CLIPBOARD" "What is this?")
                copy_to_clipboard_chosen="$(printf "%s\n" "${copy_to_clipboard_options[@]}" | rofi_cmd "Copy to clipboard" "ESC to go back")"
                [ -z "$copy_to_clipboard_chosen" ] && break

                case "$copy_to_clipboard_chosen" in
                    "Copy"*)
                        toggle_bool "VIBRANIUM_GLOBAL_COPY_TO_CLIPBOARD"
                        break
                        ;;
                    "What"*)
                        msg="\n<span foreground='${P_ACCENT}'><b>•</b></span> "
                        msg+="<b>Whether to automatically copy to clipboard when working with files</b>\n\n"
                        msg+="This could be a <span foreground='${P_YELLOW}'><b>screenshot</b></span>, a recorded or downscaled "
                        msg+="<span foreground='${P_YELLOW}'><b>video</b></span>,\nor any other type of file operation"
                        notify-send -r 3 -t 15000 "What is this?" "$msg"
                        ;;
                esac
            done
            ;;
        "Now playing"*)
            now_playing_index=0
            while :; do
                source "$VIBRANIUM_USER_SETTINGS"
                now_playing_options=(
                    "Now playing notification : $VIBRANIUM_GLOBAL_SHOW_NOW_PLAYING"
                    "Show on lock screen      : $VIBRANIUM_GLOBAL_SHOW_NOW_PLAYING_LOCKSCREEN"
                    "Include album art        : $VIBRANIUM_GLOBAL_NOW_PLAYING_SHOW_ALBUM_ART"
                    "What is this?"
                )
                now_playing_chosen="$(printf "%s\n" "${now_playing_options[@]}" |
                    rofi_cmd "Now playing" "ESC to go back" -selected-row "$now_playing_index")"
                [ -z "$now_playing_chosen" ] && break

                for i in "${!now_playing_options[@]}"; do
                    if [ "${now_playing_options[$i]}" = "$now_playing_chosen" ]; then
                        now_playing_index="$i"
                        break
                    fi
                done

                if [ "$now_playing_index" -eq 2 ]; then
                    now_playing_index=0
                fi

                case "$now_playing_chosen" in
                    "Show"*)
                        toggle_bool "VIBRANIUM_GLOBAL_SHOW_NOW_PLAYING_LOCKSCREEN"
                        ;;
                    "Now"*)
                        toggle_bool "VIBRANIUM_GLOBAL_SHOW_NOW_PLAYING"
                        ;;
                    "Include"*)
                        toggle_bool "VIBRANIUM_GLOBAL_NOW_PLAYING_SHOW_ALBUM_ART"
                        ;;
                    "What"*)
                        msg="\n<span foreground='${P_ACCENT}'><b>•</b></span> <b>"
                        msg+="Whether to show 'Now Playing' notification after session unlock</b>\n\n"
                        msg+="Note that when '<span foreground='${P_YELLOW}'><b>Include album art</b></span>' is "
                        msg+="'<span foreground='${P_GREEN}'><b>true</b></span>' and a web-based player is used, it\n"
                        msg+="takes some time to download an album art from the internet in order to display"
                        notify-send -r 3 -t 15000 "What is this?" "$msg"
                        ;;
                esac
            done
            ;;
        "Blur"*)
            _lockscreen_blur_menu
            ;;
        "Pause"*)
            while :; do
                pause_on_lock_options=(
                    "Pause music on session lock : $VIBRANIUM_GLOBAL_PAUSE_MUSIC_ON_SESSION_LOCK"
                    "What is this?"
                )
                pause_on_lock_chosen="$(printf "%s\n" "${pause_on_lock_options[@]}" | rofi_cmd "Pause music on lock" "ESC to go back")"
                [ -z "$pause_on_lock_chosen" ] && break

                case "$pause_on_lock_chosen" in
                    "Pause"*)
                        toggle_bool "VIBRANIUM_GLOBAL_PAUSE_MUSIC_ON_SESSION_LOCK"
                        break
                        ;;
                    "What"*)
                        msg="\n<span foreground='${P_GREEN}'><b>•</b></span> <b>Whether to pause "
                        msg+="the active music when locking session</b>\n\n"
                        msg+="When <span foreground='${P_GREEN}'><b>enabled</b></span>, "
                        msg+="music will fade out when the screen is\nlocked and fade back in when it is unlocked."
                        notify-send -r 3 -t 15000 "What is this?" "$msg"
                        ;;
                esac
            done
            ;;
        "Welcome"*)
            while :; do
                welcome_back_options=("Welcome notification : $VIBRANIUM_GLOBAL_SHOW_WELCOME_BACK_NOTIFICATION" "What is this?")
                welcome_back_chosen="$(printf "%s\n" "${welcome_back_options[@]}" | rofi_cmd "Welcome back" "ESC to go back")"
                [ -z "$welcome_back_chosen" ] && break

                case "$welcome_back_chosen" in
                    "Welcome"*)
                        toggle_bool "VIBRANIUM_GLOBAL_SHOW_WELCOME_BACK_NOTIFICATION"
                        break
                        ;;
                    "What"*)
                        msg="<b>Whether to show the '<span foreground='${P_YELLOW}'>Welcome back, ${USER}!</span>' "
                        msg+="notification when unlocking session</b>\n\n"
                        notify-send -r 3 -t 15000 "What is this?" "$msg"
                        ;;
                esac
            done
            ;;
        *"App launcher"*)
            index=0
            while :; do
                source "$VIBRANIUM_USER_SETTINGS"
                app_launcher_options=(
                    "Auto select           : $VIBRANIUM_GLOBAL_APP_LAUNCHER_AUTO_SELECT"
                    "Search engine         : $VIBRANIUM_GLOBAL_SEARCH_ENGINE"
                    "Show app icons        : $VIBRANIUM_GLOBAL_APP_LAUNCHER_SHOW_ICONS"
                    "Show on session start : $VIBRANIUM_GLOBAL_APP_LAUNCHER_SHOW_ON_START"
                )
                app_launcher_chosen="$(printf "%s\n" "${app_launcher_options[@]}" | rofi_cmd "App launcher" "ESC to go back" -selected-row "$index")"
                [[ -z $app_launcher_chosen ]] && break

                for i in "${!app_launcher_options[@]}"; do
                    if [[ "${app_launcher_options[$i]}" == "$app_launcher_chosen" ]]; then
                        index="$i"
                        break
                    fi
                done

                case "$app_launcher_chosen" in
                    "Show on session"*)
                        toggle_bool "VIBRANIUM_GLOBAL_APP_LAUNCHER_SHOW_ON_START"
                        ;;
                    "Show app icons"*)
                        toggle_bool "VIBRANIUM_GLOBAL_APP_LAUNCHER_SHOW_ICONS"
                        ;;
                    "Search engine"*)
                        while :; do
                            srch_engns=("Google" "DuckDuckGo" "Microsoft Bing")
                            srch_engns_chsn="$(printf "%s\n" "${srch_engns[@]}" | rofi_cmd "Search engine" "ESC to go back")"
                            [[ -z "$srch_engns_chsn" ]] && break

                            if [[ ! "${srch_engns[*]}" =~ $srch_engns_chsn ]]; then
                                notify-send -r 3 -t 2000 "Vibranium" "Invalid option"
                                continue
                            else
                                if [[ "$srch_engns_chsn" == "Microsoft Bing" ]]; then
                                    srch_engns_chsn="bing"
                                fi
                                option-validate "VIBRANIUM_GLOBAL_SEARCH_ENGINE"
                                sed -i "/VIBRANIUM_GLOBAL_SEARCH_ENGINE/s/=.*/=\"${srch_engns_chsn,,}\"/" \
                                    "$VIBRANIUM_USER_SETTINGS"
                                break
                            fi
                        done
                        ;;
                    "Auto"*)
                        while :; do
                            auto_select_options=("Auto select : $VIBRANIUM_GLOBAL_APP_LAUNCHER_AUTO_SELECT" "What is this?")
                            auto_select_chosen="$(printf "%s\n" "${auto_select_options[@]}" | rofi_cmd "Auto select" "ESC to go back")"
                            [[ -z $auto_select_chosen ]] && break

                            case "$auto_select_chosen" in
                                "Auto"*)
                                    toggle_bool "VIBRANIUM_GLOBAL_APP_LAUNCHER_AUTO_SELECT"
                                    break
                                    ;;
                                "What"*)
                                    msg="\n<span foreground='${P_ACCENT}'><b>•</b></span> <b>Whether to automatically select the last remaining entry</b>\n\n"
                                    msg+="When only one entry remains in the menu after filtering, automatically launch it.\n"
                                    msg+="This can significantly speed up application launch and menu navigation, but may seem inconvenient at first\n\n"
                                    msg+="<span foreground='${P_ACCENT}'><b>•</b></span> <b>This does not affect the clipboard menu</b>"
                                    notify-send -r 3 -t 20000 "What is this?" "$msg"
                                    ;;
                            esac
                        done
                        ;;
                esac
            done
            ;;
        *"Notifications"*)
            while :; do
                dunst_cfg="$XDG_CONFIG_HOME/dunst/dunstrc"
                current_height="$(sed -n 's/.*progress_bar_height[[:space:]]*=[[:space:]]*\([0-9]\+\).*/\1/p' "$dunst_cfg")"
                current_timeout="$(sed -n 's/.*timeout[[:space:]]*=[[:space:]]*\([0-9]\+\).*/\1/p' "$dunst_cfg")"
                notification_options=(
                    "Notification timeout : ${current_timeout}s"
                    "Progress bar height  : ${current_height}px"
                )
                notification_chosen="$(printf "%s\n" "${notification_options[@]}" | rofi_cmd "Notifications" "")"
                [[ -z "$notification_chosen" ]] && break

                case "$notification_chosen" in
                    "Progress"*)
                        while :; do
                            prompt="Progress bar height (in px)"
                            input="$(printf "%s" "$prompt" | rofi_cmd "Height" "int (10px-25px)")"
                            [[ -z "$input" ]] && break
                                   [[ "$prompt" == "$input" ]] && continue

                            if [[ ! "$input" =~ ^[0-9]+$ ]]; then
                                notify-send -r 2 -t 2000 -u critical "Vibranium" \
                                    "Only integers allowed"
                                  continue
                            fi

                            if ((input < 10 || input > 25)); then
                                notify-send -r 2 -t 1500 -u critical "Vibranium" \
                                    "A value between 10px and 25px"
                                          continue
                            fi

                            sed -iE "s/\(progress_bar_height[[:space:]]*=[[:space:]]*\)[0-9]\+/\1${input}/" \
                                "$XDG_CONFIG_HOME/dunst/dunstrc"
                                          vibranium-cmd-refresh-dunst
                            break
                        done
                        ;;
                    "Notification timeout"*)
                        while :; do
                            input="$(printf "Timeout (in seconds)" | rofi_cmd "Timeout" "ESC to go back")"
                            [[ -z "$input" ]] && break

                            if [[ ! "$input" =~ ^[0-9]+$ ]]; then
                                notify-send -r 2 -t 2000 -u critical "Vibranium" \
                                    "Only integers allowed"
                                  continue
                            fi

                            sed -iE "s/\(timeout[[:space:]]*=[[:space:]]*\)[0-9]\+/\1${input}/" \
                                "$XDG_CONFIG_HOME/dunst/dunstrc"
                                          vibranium-cmd-refresh-dunst
                            break
                        done
                        ;;
                esac
            done
            ;;
        "OSD enabled"*)
            while :; do
                source "$VIBRANIUM_USER_SETTINGS"
                current_height="$(sed -n 's/.*min-height:[[:space:]]*\([0-9]\+\)px.*/\1/p' "$XDG_CONFIG_HOME/swayosd/style.css")"

                osd_options=(
                    "OSD enabled         : $VIBRANIUM_GLOBAL_USE_OSD"
                )

                if [[ "$VIBRANIUM_GLOBAL_USE_OSD" == false ]]; then
                    osd_options+=("<span alpha='70%'>Progress bar height : ${current_height}px</span> <span foreground='${P_RED}'>()</span>")
                else
                    osd_options+=("Progress bar height : ${current_height}px")
                fi

                osd_chosen="$(printf "%s\n" "${osd_options[@]}" | rofi_cmd "OSD" "")"
                [[ -z "$osd_chosen" ]] && break

                case "$osd_chosen" in
                    *"()"*)
                        msg="This option is <span foreground='${P_RED}'><b>locked</b></span> "
                        msg+="because OSD is <span foreground='${P_RED}'><b>disabled</b></span> "
                        notify-send -r 1 "This option is locked" "$msg"
                        ;;
                    "OSD enabled"*)
                        if [[ "$(toggle_bool -v "VIBRANIUM_GLOBAL_USE_OSD")" == "false" ]]; then
                            systemctl --user disable --now swayosd &
                        else
                            systemctl --user enable --now swayosd &
                        fi
                        ;;
                    "Progress"*)
                        while :; do
                            prompt="Progress bar height (in px)"
                            input="$(printf "%s" "$prompt" | rofi_cmd "Height" "int (8px-32px)")"
                            [[ -z "$input" ]] && break
                                   [[ "$prompt" == "$input" ]] && continue
                            [[ ! "$input" =~ ^[0-9]+$ ]] && continue

                            if ((input < 8 || input > 32)); then
                                notify-send -r 2 -t 1500 -u critical "Vibranium" "A value between 8px and 32px!"
                                continue
                            fi

                            sed -i "/min-height/s/:.*/:\t${input}px;/" "$XDG_CONFIG_HOME/swayosd/style.css"
                            systemctl --user restart swayosd
                            break
                        done
                        ;;
                esac
            done

            ;;
        "Confirm"*)
            while :; do
                confirm_to_kill_options=("Confirm to kill : $VIBRANIUM_GLOBAL_CONFIRM_TO_KILL" "What is this?")
                confirm_to_kill_chosen="$(printf "%s\n" "${confirm_to_kill_options[@]}" | rofi_cmd "Confirm to kill" "ESC to go back")"
                [ -z "$confirm_to_kill_chosen" ] && break

                case "$confirm_to_kill_chosen" in
                    "Confirm"*)
                        toggle_bool "VIBRANIUM_GLOBAL_CONFIRM_TO_KILL"
                        break
                        ;;
                    "What"*)
                        msg="\n<span foreground='${P_ACCENT}'><b>•</b></span> <b>Whether to confirm action when triggering the kill window shortcut</b>\n"
                        msg+="<span foreground='${P_ACCENT}'><b>•</b></span> <b>Setting it to true helps prevent accidental force window kills</b>\n\n"
                        msg+="When the <span foreground='${P_RED}'><b>force window kill</b></span> shortcut is triggered, this\n"
                        msg+="option asks you to press it again to confirm the action"
                        notify-send -r 3 -t 15000 "What is this?" "$msg"
                        ;;
                esac
            done
            ;;
        *"flash"*""*)
            msg="Option is not available because animations disabled"
            notify-send "This option is locked" "$msg"
            ;;
        *"Screen / Border flash"*)
            index=0
            while :; do
                f_opts=("Screen" "Border")
                f_chosen="$(printf "%s\n" "${f_opts[@]}" | rofi_cmd "Flash effect" "ESC to go back" -selected-row "$index")"
                [[ -z "$f_chosen" ]] && break

                for i in "${!f_opts[@]}"; do
                    if [[ "${f_opts[$i]}" == "$f_chosen" ]]; then
                        index="$i"
                        break
                    fi
                done

                case "$f_chosen" in
                    "Screen") _flash_submenu VIBRANIUM_GLOBAL_FLASH_SCREEN VIBRANIUM_GLOBAL_FLASH_SCREEN_SPEED "Screen" ;;
                    "Border") _flash_submenu VIBRANIUM_GLOBAL_FLASH_BORDER VIBRANIUM_GLOBAL_FLASH_BORDER_SPEED "Border" ;;
                esac
            done
            ;;
        "Power menu style"*)
            option-validate "VIBRANIUM_GLOBAL_POWER_MENU_STYLE"

            if [[ "$VIBRANIUM_GLOBAL_POWER_MENU_STYLE" == "overlay" ]]; then
                sed -i "/^VIBRANIUM_GLOBAL_POWER_MENU_STYLE/s/=.*/=\"menu\"/" "$VIBRANIUM_USER_SETTINGS"
            else
                sed -i "/^VIBRANIUM_GLOBAL_POWER_MENU_STYLE/s/=.*/=\"overlay\"/" "$VIBRANIUM_USER_SETTINGS"
            fi
            ;;
    esac
done
