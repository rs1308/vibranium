#!/bin/bash

source "$VIBRANIUM_PATH/vibranium-core-lib"

CONFIG="$XDG_CONFIG_HOME/hypr/hyprland.conf.d/advanced.conf"
INDEX=0

while :; do
mapfile -t LINES < <(
    hyprctl --batch -j \
        "getoption misc:vrr; \
         getoption misc:vfr; \
         getoption misc:middle_click_paste; \
         getoption render:direct_scanout; \
         getoption misc:disable_autoreload" \
    | jq -s -r '.[] | 
        if .option == "misc:vrr" then
            if .int == 0 then "false"
            elif .int == 1 then "true"
            else "fullscreen"
            end
        else
            if .int == 1 then "true" else "false" end
        end'
)

	current_vrr="${LINES[0]}"
	current_vfr="${LINES[1]}"
	current_middle_click="${LINES[2]}"
	current_direct_scanout="${LINES[3]}"
	current_autoreload="${LINES[4]}"

	OPTIONS=(
		"Variable Refresh Rate : $current_vrr"
		"Variable Frame Rate   : $current_vfr"
		"Disable Auto Reload   : $current_autoreload"
		"Middle Click Paste    : $current_middle_click"
		"Direct Scanout        : $current_direct_scanout"
	)

	CHOSEN="$(printf "%s\n" "${OPTIONS[@]}" | rofi_cmd "Advanced" "ESC to go back" -selected-row "$INDEX")"
	[[ -z "$CHOSEN" ]] && break

	for i in "${!OPTIONS[@]}"; do
        if [ "${OPTIONS[$i]}" = "$CHOSEN" ]; then
            INDEX="$i"
            break
        fi
    done

	case "$CHOSEN" in
		"Disable Auto Reload"*)
			case "$current_autoreload" in
				"true")  vibranium-cmd-edit-wm-config "misc:disable_autoreload:false" "$CONFIG" ;;
				"false") vibranium-cmd-edit-wm-config "misc:disable_autoreload:true"  "$CONFIG" ;;
			esac
		;;
		"Middle Click Paste"*)
			case "$current_middle_click" in
				"true")  vibranium-cmd-edit-wm-config "misc:middle_click_paste:false" "$CONFIG" ;;
				"false") vibranium-cmd-edit-wm-config "misc:middle_click_paste:true"  "$CONFIG" ;;
			esac
		;;
		"Variable Frame Rate"*)
			case "$current_vfr" in
				"true")  vibranium-cmd-edit-wm-config "misc:vfr:false" "$CONFIG" ;;
				"false") vibranium-cmd-edit-wm-config "misc:vfr:true"  "$CONFIG" ;;
			esac
		;;
		"Direct Scanout"*)
			while :; do
				ds_opts=("Direct Scanout : $current_direct_scanout" "What is this?")
				ds_chosen="$(printf "%s\n" "${ds_opts[@]}" | rofi_cmd "Direct Scanout" "ESC to go back")"
				[[ -z "$ds_chosen" ]] && break

				case "$ds_chosen" in
					"Direct Scanout"*)
						case "$current_direct_scanout" in
							"true")
								vibranium-cmd-edit-wm-config "render:direct_scanout:false" "$CONFIG"
								;;
							"false")
								vibranium-cmd-edit-wm-config "render:direct_scanout:true"  "$CONFIG"
								;;
						esac
						;;
					"What is this?")
						msg+="Direct Scanout lets the GPU send frames of a fullscreen app "
						msg+="<span foreground='${P_ACCENT}'><b>straight to the monitor</b></span>, "
						msg+="bypassing the compositor\n\nThis <span foreground='${P_GREEN}'><b>reduces input latency and improves performance</b></span>, "
						msg+="but some effects may not display correctly, so disable if glitches appear"
						notify-send -r 3 -t 15000 "Direct Scanout" "$msg"
						continue
				esac
				break
			done
		;;
		"Variable Refresh Rate"*)
			while :; do
				vrr_opts=("Enable" "Disable" "Fullscreen only" "What is this?")
				vrr_chosen="$(printf "%s\n" "${vrr_opts[@]}" | rofi_cmd "VRR" "ESC to go back")"
				[[ -z "$vrr_chosen" ]] && break

				case "$vrr_chosen" in
					"Enable") 
						vibranium-cmd-edit-wm-config "misc:vrr:1" "$CONFIG"
					;;
					"Disable")
						vibranium-cmd-edit-wm-config "misc:vrr:0" "$CONFIG"
					;;
					"Fullscreen only")
						vibranium-cmd-edit-wm-config "misc:vrr:2" "$CONFIG"
					;;
					"What is this?")
						msg="<span foreground='${P_ACCENT}'><b>â€¢</b></span> "
						msg+="<b>Adjusts the monitor's refresh rate to match the GPU output</b>\n\n"
						msg+="This <span foreground='${P_GREEN}'><b>prevents</b></span> "
						msg+="<span foreground='${P_ACCENT}'><b>tearing</b></span> and "
						msg+="<span foreground='${P_ACCENT}'><b>stuttering</b></span>, but can sometimes cause \n"
						msg+="visible <span foreground='${P_ACCENT}'><b>flickering</b></span> and may "
						msg+="<span foreground='${P_YELLOW}'><b>slightly increase eye fatigue</b></span> in some cases"
						notify-send -r 3 -t 10000 "VRR (Variable Refresh Rate)" "$msg"
						continue
				esac
				break
			done
			;;
	esac

	hyprctl -q reload
done
