#!/bin/bash

# A small piece of logic that runs when the session starts.
# Nothing much is happening here right now, but in the future, 
# I think it will be possible to implement something like self-check for the entire setup.

source "$VIBRANIUM_PATH/vibranium-core-lib"

[ ! -d "$VIBRANIUM_STATE" ] && mkdir "$VIBRANIUM_STATE"

if [ -f "$VIBRANIUM_STATE/first-boot" ]; then
	vibranium-utils-first-boot
fi

if [ ! -d "$VIBRANIUM_STATE/wallpaper" ]; then
	mkdir -p "$VIBRANIUM_STATE"/wallpaper
	vibranium-utils-wallpaper-get \
		> "$VIBRANIUM_STATE/wallpaper/$(vibranium-theme-get)"
fi

# ddcutil (external monitor brightness control)
if [[ $VIBRANIUM_BRIGHTNESS_USE_DDC_CONTROL == true ]]; then
	if [ ! -f "$VIBRANIUM_STATE/i2c-bus" ]; then
		ddcutil detect 2> /dev/null | awk -F'i2c-' '/I2C bus/{print $2}' \
			> "$VIBRANIUM_STATE/i2c-bus"
	fi
fi

if [ "$VIBRANIUM_GLOBAL_SHOW_WALLPAPER" = true ]; then
	case "$(systemctl --user show hyprpaper -p UnitFileState --value)" in
		disabled) systemctl --user enable --now hyprpaper
	esac
else
	case "$(systemctl --user show hyprpaper -p UnitFileState --value)" in
		enable) systemctl --user disable --now hyprpaper
	esac
fi

# If state file doesn't exist - create one and disable
# night light (by default). We still need hyprsunset
# running in background because screen flashing effect
# depends on it. It is not the best solution though, and
# because of the while loop we must keep this check at the end
if [ ! -f "$VIBRANIUM_STATE/night-light" ]; then
	echo "suspended" > "$VIBRANIUM_STATE/night-light"
	hyprctl -q hyprsunset identity
elif [ "$(<"$VIBRANIUM_STATE/night-light")" = "suspended" ]; then
	while ! pkill -0 hyprsunset; do
		sleep 0.05
	done
	hyprctl -q hyprsunset identity
fi
