#!/usr/bin/env bash

source "$VIBRANIUM_PATH/vibranium-core-lib"

ACTIONS=("Apply tweaks" "Video downscaler")

if command -v pass >/dev/null; then
	ACTIONS+=("Password manager")
fi

if systemd-inhibit | grep "Prevent system suspend is active" > /dev/null; then
	ACTIONS+=("<b><i>Disable sleep inhibition</i></b>")
else
	ACTIONS+=("Enable sleep inhibition")
fi

ACTIONS+=("Reload Vibranium configuration")

read -r PID NAME <<< "$(hyprctl -j activewindow | jq -r '[.pid,.initialTitle]|@tsv')"
if [[ -n "$PID" && "$(ps -o state= -p "$PID" | tr -d '[:space:]')" != T ]]; then
	ACTIONS+=("Freeze <span foreground='${P_YELLOW}'><b><i>${NAME}</i></b></span>")
elif [[ -n "$NAME" ]]; then
	ACTIONS+=("Unfreeze <span foreground='${P_YELLOW}'><b><i>${NAME}</i></b></span>")
fi

while true; do
    CHOSEN="$(printf "%s\n" "${ACTIONS[@]}" | rofi_cmd "Utilities" "ESC to go back")"

    case "$CHOSEN" in
		"Apply tweaks")
			while true; do
				tweaks_opts=("System" "Apps")
				tweaks_chosen="$(printf "%s\n" "${tweaks_opts[@]}" | rofi_cmd "Tweaks" "ESC to go back")"
				[[ -z $tweaks_chosen ]] && break
				
				case "$tweaks_chosen" in
					"Apps")
						vibranium-menu-tweaks
						;;
					"System")
						vibranium-menu-tweaks-system
						;;
				esac
			done
			;;
		"Reload Vibranium configuration")
			vibranium-utils-reload
			vibranium-cmd-kill-rofi
			exit 0
			;;
        *"sleep inhibition"*)
			vibranium-cmd-inhibit-toggle
			vibranium-cmd-kill-rofi
			exit 0
            ;;
        "Video downscaler")
            if ! vibranium-utils-video-downscaler; then
				exit 0
			fi
            ;;
		"Freeze"*|"Unfreeze"*)
			vibranium-cmd-freeze-pid-toggle
			vibranium-cmd-kill-rofi
			exit 0
			;;
		"Password manager")
			vibranium-utils-password-manager
			;;
        "" | *)
            exit 1
            ;;
    esac
done
