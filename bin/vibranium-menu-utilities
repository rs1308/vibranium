#!/usr/bin/env bash

source "$VIBRANIUM_PATH/vibranium-core-lib"

if command -v pass >/dev/null; then
	ACTIONS=("Password manager")
fi

ACTIONS+=("Video downscaler" "Apply custom tweaks")

if systemd-inhibit | grep "Prevent system suspend is active" > /dev/null; then
	ACTIONS+=("<b><i><u>Disable sleep inhibition</u></i></b>")
else
	ACTIONS+=("Enable sleep inhibition")
fi

ACTIONS+=("Reload Vibranium configuration")

read -r PID NAME <<< "$(hyprctl -j activewindow | jq -r '[.pid,.initialTitle]|@tsv')"
if [[ -n "$PID" && "$(ps -o state= -p "$PID" | tr -d '[:space:]')" != T ]]; then
	ACTIONS+=("===============================")
	ACTIONS+=("Freeze <span foreground='${P_YELLOW}'><b><i><u>${NAME}</u></i></b></span>")
elif [[ -n "$NAME" ]]; then
	ACTIONS+=("===============================")
	ACTIONS+=("Unfreeze <span foreground='${P_YELLOW}'><b><i><u>${NAME}</u></i></b></span>")
fi

while true; do
    CHOSEN="$(printf "%s\n" "${ACTIONS[@]}" | rofi_cmd "Utilities" "ESC to go back")"

    case "$CHOSEN" in
		"Apply custom tweaks")
			vibranium-menu-tweaks
			;;
		"Reload Vibranium configuration")
			vibranium-utils-reload
			vibranium-cmd-kill-rofi
			exit 0
			;;
        *"sleep inhibition"*)
			vibranium-cmd-inhibit-toggle
			vibranium-cmd-kill-rofi
			exit 0
            ;;
        "Video downscaler")
            if ! vibranium-utils-video-downscaler; then
				exit 0
			fi
            ;;
		"Freeze"*|"Unfreeze"*)
			vibranium-cmd-freeze-pid-toggle
			vibranium-cmd-kill-rofi
			exit 0
			;;
		"Password manager")
			vibranium-utils-password-manager
			;;
        "" | *)
            exit 1
            ;;
    esac
done
