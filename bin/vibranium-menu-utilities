#!/usr/bin/env bash

source "$VIBRANIUM_PATH/vibranium-core-lib"

if command -v pass >/dev/null; then
	ACTIONS=("Password manager")
fi

ACTIONS+=("Downscale a video")

if [ -f /opt/spicetify-cli/spicetify ]; then
	ACTIONS+=("Apply custom tweaks")
fi

if systemd-inhibit | grep "Prevent system suspend is active" > /dev/null; then
	ACTIONS+=("<b><i><u>Disable sleep inhibition</u></i></b>")
else
	ACTIONS+=("Enable sleep inhibition")
fi

ACTIONS+=("Reload Vibranium configuration")

read -r PID NAME <<< "$(hyprctl -j activewindow | jq -r '[.pid,.initialTitle]|@tsv')"
if [[ -n "$PID" && "$(ps -o state= -p "$PID" | tr -d '[:space:]')" != T ]]; then
	ACTIONS+=("===============================")
	ACTIONS+=("Freeze <span foreground='${P_YELLOW}'><b><i><u>${NAME}</u></i></b></span>")
elif [[ -n "$NAME" ]]; then
	ACTIONS+=("===============================")
	ACTIONS+=("Unfreeze <span foreground='${P_YELLOW}'><b><i><u>${NAME}</u></i></b></span>")
fi

while true; do
    CHOSEN="$(printf "%s\n" "${ACTIONS[@]}" | rofi_cmd "Utilities" "ESC to go back")"

    case "$CHOSEN" in
		"Apply custom tweaks")
			while true; do
				custom_tweaks_chosen=()
				if ! grep -q "adblock" "$XDG_CONFIG_HOME/spicetify/config-xpui.ini"; then
					custom_tweaks_options+=("Install Spotify adblock")
				else
					custom_tweaks_options+=("Remove Spotify adblock")
				fi

				custom_tweaks_chosen="$(printf "${custom_tweaks_options[@]}" | rofi_cmd "App tweaks" "ESC to go back")"
				[[ -z "$custom_tweaks_chosen" ]]

				case "$custom_tweaks_chosen" in
					"Install Spotify adblock")
						vibranium-cmd-spicetify-adblock install
						vibranium-cmd-kill-rofi
						exit 0
						;;
					"Remove Spotify adblock")
						vibranium-cmd-spicetify-adblock remove
						vibranium-cmd-kill-rofi
						exit 0
						;;
				esac
			done
			;;
		"Reload Vibranium configuration")
			vibranium-utils-reload
			vibranium-cmd-kill-rofi
			exit 0
			;;
        *"sleep inhibition"*)
			vibranium-cmd-inhibit-toggle
			vibranium-cmd-kill-rofi
			exit 0
            ;;
        "Downscale a video")
            if ! vibranium-utils-video-downscale; then
				exit 0
			fi
            ;;
		"Freeze"*|"Unfreeze"*)
			vibranium-cmd-freeze-pid-toggle
			vibranium-cmd-kill-rofi
			exit 0
			;;
		"Password manager")
			vibranium-utils-password-manager
			;;
        "" | *)
            exit 1
            ;;
    esac
done
