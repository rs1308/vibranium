#!/usr/bin/env bash

# shellcheck disable=SC2034

source "$VIBRANIUM_PATH/vibranium-core-lib"

export SUDO_PROMPT; SUDO_PROMPT="$(printf '%s[VIBRANIUM]%s Password for %s: ' "$RED" "$RESET" "$USER")"

if ! tty -s; then
	exec setsid vibranium-cmd-launch-terminal "$0" "$@"
	exit 0
fi

printf "\n\e[33m%s\e[0m\n\n" "$(cat "$VIBRANIUM/logo.txt")"

if ! sudo -v; then
	echo -e "${RED}[VIBRANIUM]${RESET} Operation aborted"
	exit 1
fi

# Hide cursor
printf '\e[?25l'

yay -Sy &>/dev/null &
spinner "$!" "${YELLOW}[VIBRANIUM]${RESET} Refreshing repositories" ""

mapfile -t pkg_list < <(yay -Qqu)

if [[ -z "${pkg_list[*]}" ]]; then
	echo -e "${YELLOW}[VIBRANIUM]${RESET} You are up to date "
	read -n1 -r -p $'\e[0;33m[VIBRANIUM]\e[0m Press any key to close this window' dummy
	exit 0
fi

echo -e "${YELLOW}[VIBRANIUM]${RESET} ${#pkg_list[@]} packages are awaiting updates"
echo -e "${YELLOW}[VIBRANIUM]${RESET} Starting system update"

for pkg in "${pkg_list[@]}"; do
	if ! pacman -Si "$pkg" >/dev/null 2>&1; then
		aur_flag=" (AUR)"
	else
		aur_flag=""
	fi

	printf "\r\033[K%s[VIBRANIUM]%s Updating %s%s%s%s " \
		"$YELLOW" "$RESET" "$GRAY" "$pkg" "$aur_flag" "$RESET"

	start_time=$(date +%s)
	yay -Su --noconfirm "$pkg" >/dev/null 2>&1 &
	pid=$!

	while kill -0 "$pid" 2>/dev/null; do
		sleep 1
		elapsed=$(( $(date +%s) - start_time ))
		if (( elapsed > 10 )); then
			printf "\r\033[K%s[VIBRANIUM]%s Updating %s%s [%ds]%s" \
				"$YELLOW" "$RESET" "$GRAY" "$pkg$aur_flag" "$elapsed" "$RESET"
		fi
	done

	wait "$pid"
done

vibranium-cmd-refresh-waybar-module pacman
printf "\r\033[K%s[VIBRANIUM]%s All packages updated" "$YELLOW" "$RESET"
echo -e "\n${YELLOW}[VIBRANIUM]${RESET} System update complete"

important_regex='^(systemd|linux(-.*)?|networkmanager|iwd)$'
for pkg in "${pkg_list[@]}"; do
    if [[ $pkg =~ $important_regex ]]; then
        echo -e "${YELLOW}[VIBRANIUM]${RESET} Important system components have been updated"

        prompt=$'\e[0;33m[VIBRANIUM]\e[0m System restart is recommended. Restart now? (Y/n): '
        while :; do
            printf "%s\e[?25h" "$prompt"
            read -r answer
			printf '\e[?25l'
            case "$answer" in
                [Yy][Ee][Ss]|[Yy]|"")
                    echo -e "${YELLOW}[VIBRANIUM]${RESET} Restarting..."
					sleep 2; systemctl reboot
					exit 0
                    ;;
                [Nn][Oo]|[Nn])
                    break
                    ;;
                *)
                    printf '\r\e[K'
                    ;;
            esac
        done

        break
    fi
done

read -n1 -r -p $'\e[0;33m[VIBRANIUM]\e[0m Press any key to close this window' dummy
