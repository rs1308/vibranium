#!/usr/bin/env bash

source "$VIBRANIUM_PATH/vibranium-core-lib"

case "$1" in
    "before")
        if [ "$VIBRANIUM_GLOBAL_PAUSE_MUSIC_ON_SESSION_LOCK" = "false" ]; then
            exit 0
        fi

        if [[ "$(playerctl status 2> /dev/null)" == "Playing" ]]; then
            vibranium-core-player-control toggle &
            touch "$XDG_RUNTIME_DIR/restore-player"
        elif [[ "$(mpc status 2> /dev/null | awk 'NR==2 {print $1}')" == "[playing]" ]]; then
            touch "$XDG_RUNTIME_DIR/restore-player"
            vibranium-core-player-control toggle &
        fi
        ;;
    "after")
        if [ "$VIBRANIUM_GLOBAL_SHOW_WELCOME_BACK_NOTIFICATION" = "true" ]; then
            notify-send -r 5 -t 2500 "Vibranium" "Welcome back, <span foreground='${P_ACCENT}'><b>$USER</b></span>!"
            delay=true
        fi

        if [ "$VIBRANIUM_GLOBAL_PAUSE_MUSIC_ON_SESSION_LOCK" = "true" ]; then
            if [ -f "$XDG_RUNTIME_DIR/restore-player" ]; then
                vibranium-core-player-control toggle &
                rm "$XDG_RUNTIME_DIR/restore-player"

                if [[ $VIBRANIUM_GLOBAL_SHOW_NOW_PLAYING == true ]]; then
                    [[ -n $delay ]] && sleep 2
                    vibranium-cmd-now-playing
                fi
            fi
        fi
        ;;
esac
