#!/usr/bin/env bash

# shellcheck disable=SC2086
# Overcomplicated launcher based on rofi, which can:
#	- Launch applications
#	- Open local files in default applications
#	- Open links
#	- Search the internet
#
# Please note that internet search may often be unavailable when VIBRANIUM_GLOBAL_APP_LAUNCHER_AUTO_SELECT is set to true.
# This script can also open three additional menus with custom categories to open:
#	- AI
#	- Common websites
#	- Power menu

if pidof rofi >/dev/null; then
	killall rofi
	exit 0
fi

source "$VIBRANIUM_PATH/vibranium-core-lib"

# ROFI_THEME="$HOME/.config/rofi/config.rasi"

check_bool VIBRANIUM_MENU_SWAP_LAYOUT true
check_bool VIBRANIUM_GLOBAL_APP_LAUNCHER_SHOW_ICONS true

process_input() {
    local input="$*"

    case "$input" in
        "file://"*)
            input="${input#file://}"
            vibranium-cmd-launch-cmd xdg-open "$input" &
            ;;
        "https://"*)
            vibranium-cmd-launch-cmd xdg-open "$input" &
            ;;
        "DBus launch")
            exit 0
            ;;
        *)
            local word_count
            word_count=$(wc -w <<<"$input")
            word_count=${word_count//[[:space:]]/}

            if (( word_count == 1 )); then
                if [[ -x "$input" ]]; then
                    vibranium-cmd-launch-cmd "$input" &
                    exit 0
                elif command -v "$input" >/dev/null 2>&1; then
                    vibranium-cmd-launch-cmd "$input" &
                    exit 0
                elif [[ -e "$input" ]]; then
                    setsid uwsm app -S err -- xdg-open "$input" &
                    exit 0
                fi
            fi

            if [[ -e "$input" ]]; then
                setsid uwsm app -S err -- xdg-open "$input" &
                exit 0
            fi

            [ "$VIBRANIUM_GLOBAL_APP_LAUNCHER_AUTO_SELECT" = true ] && exit 0
            vibranium-cmd-launch-cmd xdg-open "https://www.google.com/search?q=${input}" &
            ;;
    esac
}

# Split for readability
case "$1" in
	"--web")
		opt_args+=(-drun-categories WebApp -display-drun "Web Apps" -no-fixed-num-lines true  -disable-history)
		opt_args+=(-icon-theme Vibranium -theme-str 'window {width: 300;}')
		;;
	"--ai")
		opt_args+=(-drun-categories AI -display-drun "AIs" -no-fixed-num-lines true  -disable-history)
		opt_args+=(-icon-theme Vibranium -theme-str 'window {width: 250;}')
		;;
	"--power")
		opt_args+=(-drun-categories Power -display-drun "Power" -no-fixed-num-lines true -disable-history)
		opt_args+=(-icon-theme Vibranium)
		;;
	*)
		opt_args+=(-drun-exclude-categories 'WebApp,AI,Power')
		;;
esac

if [ $VIBRANIUM_GLOBAL_APP_LAUNCHER_SHOW_ICONS = true ]; then
    opt_args+=(-theme-str 'configuration {show-icons: true;} element-icon {enabled: true;}')
fi

if [[ $VIBRANIUM_GLOBAL_APP_LAUNCHER_AUTO_SELECT == true ]]; then
	opt_args+=(-auto-select true)
fi

input=$(rofi -show drun -run-command "echo {cmd} {args}" "${opt_args[@]}" 2> /dev/null)

if [ ! -z "$input" ]; then
    process_input "${input[@]}"
fi
