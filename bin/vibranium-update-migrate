#!/usr/bin/env bash

# Source: omarchy

STATE_DIR="$VIBRANIUM_STATE/migrations"

YELLOW=$'\e[0;33m'
GREEN=$'\e[0;32m'
RESET=$'\e[0m'

mkdir -p "$STATE_DIR/skipped"
for file in "$VIBRANIUM"/migrations/*.sh; do
    filename=$(basename "$file")

    if [[ ! -f "$STATE_DIR/$filename" && ! -f "$STATE_DIR/skipped/$filename" ]]; then
        echo -e "${YELLOW}[VIBRANIUM]${RESET} Running migration ${GREEN}${filename%.sh}${RESET}"

        if bash "$file"; then
            touch "$STATE_DIR/$filename"
        else
            printf "%s[VIBRANIUM]%s Migration %s failed. Skip and continue? (y/N): " \
                "$YELLOW" "$RESET" "$file"
            read -r response
            case "$response" in
                [yY][eE][sS] | [yY])
                    touch "$STATE_DIR/skipped/$filename"
                    ;;
                *)
                    exit 1
                    ;;
            esac
        fi
    fi
done
