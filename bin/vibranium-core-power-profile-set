#!/usr/bin/env bash

# Power profile switcher. The code is pretty simple and clean, so I don't think it needs any explanation.

source "$VIBRANIUM_PATH/vibranium-core-lib"

QUIET=false
user_args=()
for a in "$@"; do
    case "${a,,}" in
        -q|--quiet) QUIET=true ;;
        *) user_args+=("$a") ;;
    esac
done

if ! missing_str="$(vibranium-utils-is-installed power-profiles-daemon:powerprofilesctl)"; then
    read -r -a missing <<< "$missing_str"
    notify-send -r 4 -t 5000 -u critical "$(basename "$0")" "Missing cli utilities: ${missing[*]}"
    exit 1
fi

profiles=("power-saver" "balanced" "performance")
current="$(vibranium-utils-power-profile-get)"

notify() {
	check_bool VIBRANIUM_GLOBAL_POWER_PROFILE_USE_FEEDBACK true
    if [[ $QUIET = true ]]; then
        return 0
	elif [[ "$VIBRANIUM_GLOBAL_POWER_PROFILE_USE_FEEDBACK" == false ]]; then
		return 0
    fi

    local profile="$1"
    local icon=""
    local label=""

    case "$profile" in
        "performance")
            icon="power-profile-performance-symbolic"
            label="Performance"
            ;;
        "balanced")
            icon="power-profile-balanced-symbolic"
            label="Balanced"
            ;;
        "power-saver")
            icon="power-profile-power-saver-symbolic"
            label="Powersave"
            ;;
    esac

    log "Setting power profile to ${YELLOW}'${profile}'${RESET}"
    check_bool VIBRANIUM_GLOBAL_POWER_PROFILE_USE_OSD true

    if [ "$VIBRANIUM_GLOBAL_USE_OSD" = true ] && [ "$VIBRANIUM_GLOBAL_POWER_PROFILE_USE_OSD" = true ]; then
        if ! command -v swayosd-client > /dev/null || ! pidof swayosd-server > /dev/null; then
            notify-send -r 2 -t 1500 "Vibranium" "Power profile set to <span foreground='${P_ACCENT}'>${label,,}</span>"
        else
            swayosd-client --custom-message "$label" --custom-icon "$icon"
        fi
    else
        notify-send -r 2 -t 1500 "Vibranium" "Power profile set to <span foreground='${P_ACCENT}'>${label,,}</span>"
    fi
}

raw_input="${user_args[0]:-}"
if [ ${#user_args[@]} -gt 0 ]; then
    arg="${raw_input,,}"
else
    arg=""
fi

if [[ " ${profiles[*]} " == *" $arg "* ]]; then
    target_profile="$arg"
else
    current_index=0
    for i in "${!profiles[@]}"; do
        if [[ "${profiles[$i]}" == "$current" ]]; then
            current_index=$i
            break
        fi
    done

    case "$arg" in
        "up" | "+")
            next_index=$(((current_index + 1) % ${#profiles[@]}))
            ;;
        "down" | "-")
            next_index=$(((current_index - 1 + ${#profiles[@]}) % ${#profiles[@]}))
            ;;
        "")
            next_index=$(((current_index + 1) % ${#profiles[@]}))  # default: cycle up
            ;;
        *)
            error "Invalid input: '$raw_input'"
            exit 1
            ;;
    esac

    target_profile="${profiles[$next_index]}"
fi

powerprofilesctl set "$target_profile" &
echo "$target_profile" > "${VIBRANIUM_STATE}/power-profile"
notify "$target_profile"

check_bool VIBRANIUM_BAR_POWER_PROFILE_MODULE_ENABLE false
if [ "$VIBRANIUM_BAR_POWER_PROFILE_MODULE_ENABLE" = true ]; then
	log "Updating waybar module"
	vibranium-cmd-refresh-waybar-module power-profile
fi

BLUR_ENABLED="$(hyprctl -j getoption decoration:blur:enabled | jq -r '.int')"

if [ "$target_profile" = "power-saver" ]; then
    if [ "$VIBRANIUM_GLOBAL_RESPECT_POWER_PROFILE" = "true" ]; then
        if [[ "$BLUR_ENABLED" == 1 ]]; then
            touch "$VIBRANIUM_STATE/blur.restore"
            vibranium-cmd-toggle-blur
        fi
    fi
else
    if [[ "$BLUR_ENABLED" == 0 ]] && [ -f "$VIBRANIUM_STATE/blur.restore" ]; then
        vibranium-cmd-toggle-blur
        rm "$VIBRANIUM_STATE/blur.state"
    fi
fi
